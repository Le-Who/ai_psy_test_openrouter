<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ï–≤–¥–æ–∫–∏—è –¢–µ—Å—Ç–∏–∫–æ–≤–∞</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text: #1e293b;
            --text-light: #64748b;
            --border: #e2e8f0;
            --radius: 12px;
            --danger: #ef4444;
        }

        * { box-sizing: border-box; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; }

        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        
        /* UI Components */
        .card { background: var(--surface); padding: 30px; border-radius: var(--radius); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 20px; border: 1px solid var(--border); }
        
        .btn { background: var(--primary); color: white; border: none; padding: 12px 20px; width: 100%; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: 15px;}
        .btn:hover { background: var(--primary-hover); transform: translateY(-1px); }
        .btn:disabled { opacity: 0.7; cursor: not-allowed; transform: none; }
        .btn-secondary { background: #e2e8f0; color: var(--text); }
        .btn-secondary:hover { background: #cbd5e1; }
        .btn-text { background: none; color: var(--primary); padding: 0; width: auto; font-weight: 600; }
        .btn-text:hover { text-decoration: underline; transform: none; background: none;}
        
        input, select { width: 100%; padding: 12px; margin-top: 6px; border: 1px solid var(--border); border-radius: 8px; font-size: 15px; transition: border 0.2s; }
        input:focus, select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
        label { font-weight: 600; font-size: 14px; display: block; margin-top: 18px; color: var(--text); }

        /* Views */
        .view { display: none; animation: fadeIn 0.4s ease-out; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Test UI */
        .likert-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin: 30px 0; }
        .likert-opt { border: 2px solid var(--border); padding: 15px 5px; text-align: center; border-radius: 8px; cursor: pointer; font-weight: 700; color: var(--text-light); transition: all 0.2s; }
        .likert-opt:hover { border-color: var(--primary); background: #eff6ff; color: var(--primary); }
        .likert-opt.selected { background: var(--primary); color: white; border-color: var(--primary); transform: scale(1.05); }

        .progress { height: 8px; background: #e2e8f0; border-radius: 99px; overflow: hidden; margin-bottom: 25px; }
        .bar { height: 100%; background: var(--primary); width: 0%; transition: width 0.4s ease; }

        /* Results */
        .res-item { margin-bottom: 18px; }
        .res-bar-bg { background: #f1f5f9; height: 10px; border-radius: 5px; overflow: hidden; margin-top: 6px; }
        .res-bar-fill { background: var(--primary); height: 100%; border-radius: 5px; }

        /* Loader */
        .loader { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s infinite; margin: 0 auto 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .header { text-align: center; margin-bottom: 30px; padding-top: 20px; }
        .header h1 { margin: 0; font-size: 24px; color: var(--text); }
        .header p { margin: 5px 0 0; color: var(--text-light); font-size: 14px; }
        .badge { background: #dbeafe; color: #1e40af; padding: 2px 8px; border-radius: 12px; font-size: 11px; vertical-align: middle; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>üîÆ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –¢–µ—Å—Ç–æ–≤ –∏–º–µ–Ω–∏ –î—É–Ω–∏ –ü–∞—Ö—É—á–µ–π</h1>
        <p>–†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —Ö–ª–æ–ø—å—è—Ö —Å –º–æ–ª–æ–∫–æ–º üíÖ</p>
    </div>

    <div id="errorBox" style="background:#fef2f2; color:#991b1b; padding:15px; border-radius:8px; display:none; margin-bottom:20px; border:1px solid #fecaca;"></div>

    <!-- 1. VIEW: SETUP -->
    <div id="setupView" class="view active">
        <!-- –ö–Ω–æ–ø–∫–∞ –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
        <div style="display: flex; justify-content: flex-end; margin-bottom: 10px;">
            <button onclick="app.openLibrary()" class="btn-text">üìÇ –ú–æ—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞</button>
        </div>

        <div class="card">
            <h2 style="margin-top: 0; font-size: 20px;">–ù–æ–≤—ã–π —Ç–µ—Å—Ç</h2>
            <form id="setupForm">
                <label>–¢–µ–º–∞ —Ç–µ—Å—Ç–∞</label>
                <input type="text" id="themeInput" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö—Ç–æ —Ç—ã –∏–∑ –í—Å–µ–ª–µ–Ω–Ω–æ–π –ì–∞—Ä—Ä–∏ –ü–æ—Ç—Ç–µ—Ä–∞?" required>
                
                <label>–î–ª—è –∫–æ–≥–æ (–ê—É–¥–∏—Ç–æ—Ä–∏—è)</label>
                <input type="text" id="audienceInput" value="–û–±—â–∞—è" placeholder="–ü–æ–¥—Ä–æ—Å—Ç–∫–∏, IT-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—ã...">
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <label>–í–æ–ø—Ä–æ—Å–æ–≤</label>
                        <select id="qCountInput">
                            <option value="5">5 (–ó–∞—á–µ–º?)</option>
                            <option value="10" selected>10 (–ë—ã—Å—Ç—Ä—ã–π)</option>
                            <option value="15">15 (–û–±—ã—á–Ω—ã–π)</option>
                            <option value="25">25 (–ü–æ–¥—Ä–æ–±–Ω—ã–π)</option>
                            <option value="69">69 (–¢—É–º–∞—á?)</option>
                        </select>
                    </div>
                    <div>
                        <label>–ü—Ä–æ–≤–∞–π–¥–µ—Ä</label>
                        <select disabled style="background: #f1f5f9;">
                            <option>–ê–≤—Ç–æ-–≤—ã–±–æ—Ä –ø–æ –∫–ª—é—á—É</option>
                        </select>
                    </div>
                </div>

                <label>API –ö–ª—é—á <span style="font-weight:normal; color:#64748b; font-size:12px;">(OpenRouter –∏–ª–∏ Gemini)</span></label>
                <input type="password" id="apiKeyInput" placeholder="sk-or-... –∏–ª–∏ AIza..." required>
                
                <button type="submit" class="btn" style="margin-top: 25px;">üöÄ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¢–µ—Å—Ç</button>
            </form>
        </div>
    </div>

    <!-- 2. VIEW: LIBRARY -->
    <div id="libraryView" class="view">
        <div id="libraryContent">
            <!-- –°—é–¥–∞ JS –≤—Å—Ç–∞–≤–∏—Ç —Å–ø–∏—Å–æ–∫ -->
        </div>
    </div>

    <!-- 3. VIEW: LOADING -->
    <div id="loadingView" class="view" style="text-align: center; padding-top: 50px;">
        <div class="loader"></div>
        <h3 id="loadTitle">–ó–∞–ø—É—Å–∫...</h3>
        <p id="loadDesc" style="color: var(--text-light);">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–µ–ª–µ–π</p>
    </div>

    <!-- 4. VIEW: TEST -->
    <div id="testView" class="view">
        <div class="progress"><div id="progressBar" class="bar"></div></div>
        <div class="card">
            <div style="display:flex; justify-content:space-between; margin-bottom: 15px; color: var(--text-light); font-size: 13px; font-weight: 600;">
                <span>–í–û–ü–†–û–° <span id="qNum">1</span></span>
            </div>
            <h3 id="qText" style="font-size: 22px; margin-bottom: 30px; line-height: 1.4;">...</h3>
            
            <div class="likert-grid">
                <div class="likert-opt" onclick="app.answer(1)">1</div>
                <div class="likert-opt" onclick="app.answer(2)">2</div>
                <div class="likert-opt" onclick="app.answer(3)">3</div>
                <div class="likert-opt" onclick="app.answer(4)">4</div>
                <div class="likert-opt" onclick="app.answer(5)">5</div>
            </div>
            <div style="display:flex; justify-content:space-between; font-size:13px; color:var(--text-light); padding:0 5px; font-weight:500;">
                <span>‚ùå –ù–µ—Ç / –ù–∏–∫–æ–≥–¥–∞</span>
                <span>‚úÖ –î–∞ / –í—Å–µ–≥–¥–∞</span>
            </div>
        </div>
    </div>

    <!-- 5. VIEW: RESULTS -->
    <div id="resultsView" class="view">
        <div class="card" id="resContent">
            <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <button class="btn" onclick="location.reload()">‚Ü∫ –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π</button>
            <button class="btn btn-secondary" id="saveTestBtn" onclick="app.saveCurrentTest()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫—É</button>
        </div>
    </div>
</div>

<!-- –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –°–ö–†–ò–ü–¢–û–í -->
<script src="app-settings.js"></script>
<script src="storage.js"></script> 

<script>
// --- API –ö–õ–ò–ï–ù–¢ (v3.0 Updated) ---
const api = {
    detectProvider(key) {
        return key.startsWith('AIza') ? 'gemini' : 'openrouter';
    },

    safeParseJSON(text) {
        try {
            return JSON.parse(text);
        } catch (e) {
            console.warn("Parsing failed, attempting regex extraction...");
            const match = text.match(/(\{[\s\S]*\}|\[[\s\S]*\])/);
            if (match) {
                try { return JSON.parse(match[0]); } catch (e2) {}
            }
            const mdMatch = text.match(/```(?:json)?\s*([\s\S]*?)\s*```/);
            if (mdMatch) {
                try { return JSON.parse(mdMatch[1]); } catch (e3) {}
            }
            throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞.");
        }
    },

    async call(taskName, userPrompt, schema, apiKey) {
        const provider = this.detectProvider(apiKey);
        
        // –í–ê–ñ–ù–û: –í—ã–±–æ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
        const systemPrompt = PROMPTS[provider][taskName];

        console.log(`üì° API Request: ${provider.toUpperCase()} (${taskName})`);

        if (provider === 'gemini') {
            return this.callGemini(systemPrompt, userPrompt, schema, taskName, apiKey);
        } else {
            return this.callOpenRouter(systemPrompt, userPrompt, schema, taskName, apiKey);
        }
    },

    async callOpenRouter(sys, user, schema, type, key) {
        const model = CONFIG.providers.openrouter.models[type];
        
        // –î–ª—è OpenRouter (Xiaomi) –º—ã –ø–æ–ª–∞–≥–∞–µ–º—Å—è –Ω–∞ –ø—Ä–∏–º–µ—Ä –≤ System Prompt
        const messages = [
            { role: 'system', content: sys },
            { role: 'user', content: user }
        ];

        try {
            const res = await fetch(CONFIG.providers.openrouter.endpoint, {
                method: 'POST',
                headers: CONFIG.providers.openrouter.headers(key),
                body: JSON.stringify({
                    model: model,
                    messages: messages,
                    // –í–∫–ª—é—á–∞–µ–º JSON mode
                    response_format: { type: "json_object" }, 
                    temperature: 0.6
                })
            });
            
            if (!res.ok) {
                const err = await res.json();
                throw new Error(err.error?.message || 'OpenRouter Error');
            }
            
            const data = await res.json();
            const content = data.choices[0].message.content;
            return this.safeParseJSON(content);

        } catch (e) {
            console.error("OpenRouter request failed:", e);
            throw e;
        }
    },

    async callGemini(sys, user, schema, type, key) {
        const model = CONFIG.providers.gemini.models[type];
        const url = `${CONFIG.providers.gemini.endpoint}${model}:generateContent?key=${key}`;

        // Gemini: –¥–æ–±–∞–≤–ª—è–µ–º —Å—Ö–µ–º—É –≤ –∫–æ–Ω–µ—Ü –ø—Ä–æ–º–ø—Ç–∞
        const prompt = `${sys}\n\n–û–¢–í–ï–¢–¨ –°–¢–†–û–ì–û –í FORMAT JSON:\n${JSON.stringify(schema)}\n\n–ó–ê–î–ê–ß–ê: ${user}`;

        const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    temperature: 0.7,
                    response_mime_type: "application/json"
                }
            })
        });

        if (!res.ok) {
            const err = await res.json();
            throw new Error(err.error?.message || 'Gemini Error');
        }

        const data = await res.json();
        return this.safeParseJSON(data.candidates[0].content.parts[0].text);
    }
};

// --- APP LOGIC (v3.0 Final) ---
const app = {
    state: { step: 0, answers: [], questions: [], blueprint: null, apiKey: '' },

    async start(e) {
        e.preventDefault();
        
        // 1. –û—á–∏—Å—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è (Critical fix)
        this.state.blueprint = null;
        this.state.questions = [];
        this.state.answers = [];
        this.state.step = 0;

        this.state.apiKey = document.getElementById('apiKeyInput').value.trim();
        const theme = document.getElementById('themeInput').value;
        const count = document.getElementById('qCountInput').value;
        const audience = document.getElementById('audienceInput').value;

        if(!this.state.apiKey) return alert("–í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á!");
        sessionStorage.setItem('temp_api_key', this.state.apiKey);

        this.setLoading(true, "üß† –ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä –ø—Ä–æ–µ–∫—Ç–∏—Ä—É–µ—Ç —Ç–µ—Å—Ç...");
        document.getElementById('errorBox').style.display = 'none';

        try {
            // –≠–¢–ê–ü 1: Blueprint (—Å –ø–æ–≤—Ç–æ—Ä–∞–º–∏ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏)
            let attempts = 0;
            let blueprint = null;
            
            while(attempts < 3 && !blueprint) {
                try {
                    attempts++;
                    const res = await api.call(
                        'architect',
                        `–¢–µ–º–∞: "${theme}". –ê—É–¥–∏—Ç–æ—Ä–∏—è: "${audience}". –°–æ–∑–¥–∞–π —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–µ—Å—Ç–∞.`,
                        SCHEMAS.blueprint,
                        this.state.apiKey
                    );
                    if (res && res.outcomes) blueprint = res;
                } catch (e) {
                    console.warn(`Blueprint attempt ${attempts} failed:`, e);
                    if (attempts === 3) throw e;
                }
            }
            this.state.blueprint = blueprint;

            // –≠–¢–ê–ü 2: –í–æ–ø—Ä–æ—Å—ã
            this.setLoading(true, "‚úçÔ∏è –ê–≤—Ç–æ—Ä –ø–∏—à–µ—Ç –≤–æ–ø—Ä–æ—Å—ã...");
            
            const genPrompt = `–¢–µ–º–∞: ${theme}. –¢–∏–ø: ${blueprint.testType}.
            –†–µ–∑—É–ª—å—Ç–∞—Ç—ã: ${JSON.stringify(blueprint.outcomes)}.
            –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–ø—Ä–æ—Å–æ–≤: ${count}.
            –†–∞—Å–ø—Ä–µ–¥–µ–ª–∏ –≤–µ—Å–∞ —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ (Soft Weights).`;

            const content = await api.call(
                'generator',
                genPrompt,
                SCHEMAS.questions,
                this.state.apiKey
            );
            
            this.state.questions = content.questions;
            
            // –°—Ç–∞—Ä—Ç
            this.renderQ();
            this.setView('test');

        } catch (err) {
            console.error(err);
            document.getElementById('errorBox').style.display = 'block';
            document.getElementById('errorBox').innerHTML = `<strong>–û—à–∏–±–∫–∞:</strong> ${err.message}`;
            this.setView('setup');
        }
    },

    renderQ() {
        const q = this.state.questions[this.state.step];
        document.getElementById('qNum').innerText = `${this.state.step + 1} / ${this.state.questions.length}`;
        document.getElementById('qText').innerText = q.text;
        
        const pct = (this.state.step / this.state.questions.length) * 100;
        document.getElementById('progressBar').style.width = pct + '%';
        
        document.querySelectorAll('.likert-opt').forEach(d => d.classList.remove('selected'));
    },

    answer(val) {
        this.state.answers[this.state.step] = val;
        document.querySelectorAll('.likert-opt')[val-1].classList.add('selected');
        
        setTimeout(() => {
            this.state.step++;
            if(this.state.step < this.state.questions.length) {
                this.renderQ();
            } else {
                this.finish();
            }
        }, 200);
    },

    finish() {
        this.setLoading(true, "üìä –î—É–Ω—è –ü–∞—Ö—É—á–∞—è —Å—á–∏—Ç–∞–µ—Ç...");
        this.setView('loading');
        
        setTimeout(() => {
            try {
                this.calc();
                this.setView('results');
            } catch (e) {
                alert("–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞: " + e.message);
                this.setView('setup');
            }
        }, 600);
    },

    calc() {
        if (!this.state.blueprint || !this.state.blueprint.outcomes) {
            throw new Error("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö —Ç–µ—Å—Ç–∞.");
        }
        
        const scores = {};
        this.state.blueprint.outcomes.forEach(o => scores[o.id] = 0);

        this.state.questions.forEach((q, idx) => {
            const ans = this.state.answers[idx];
            const userVal = (ans !== undefined ? ans : 3) - 3; // -2..+2
            
            if (q.mapping && Array.isArray(q.mapping)) {
                q.mapping.forEach(m => {
                    if(scores[m.outcomeId] !== undefined) {
                        scores[m.outcomeId] += (m.weight * userVal);
                    }
                });
            }
        });

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞
        const container = document.getElementById('resContent');
        let html = '';
        const isCategorical = (this.state.blueprint.testType !== 'dimensional');
        
        if(isCategorical) {
            const sorted = this.state.blueprint.outcomes.sort((a,b) => scores[b.id] - scores[a.id]);
            const win = sorted[0];
            let maxScore = Math.max(...Object.values(scores), 1); 

            html = `<div style="text-align:center; padding-bottom: 20px;">
                <div style="font-size:12px; text-transform:uppercase; letter-spacing:1px; color:#64748b; margin-bottom:10px;">–¢–≤–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</div>
                <h2 style="font-size:32px; margin:0 0 10px; color:var(--primary);">${win.name}</h2>
                <p style="font-size:18px; line-height:1.6;">${win.description}</p>
            </div>
            <div style="background:#f1f5f9; padding:20px; border-radius:12px;">
                <h4 style="margin:0 0 15px; color:#475569;">–î—Ä—É–≥–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã:</h4>`;
            
            sorted.slice(1).forEach(o => {
                let pct = 0;
                if (scores[o.id] > 0) pct = (scores[o.id] / maxScore) * 100;
                
                html += `<div class="res-item">
                    <div style="display:flex; justify-content:space-between; font-size:14px; margin-bottom:5px;">
                        <span>${o.name}</span>
                        <span style="color:#94a3b8; font-size:12px;">${Math.round(pct)}%</span>
                    </div>
                    <div class="res-bar-bg"><div class="res-bar-fill" style="width:${pct}%"></div></div>
                </div>`;
            });
            html += `</div>`;
        } else {
            html = `<h3 style="text-align:center; margin-bottom:25px;">–¢–≤–æ–π –ü—Ä–æ—Ñ–∏–ª—å</h3>`;
            this.state.blueprint.outcomes.forEach(o => {
                const s = scores[o.id];
                const pct = Math.min(100, Math.max(0, 50 + (s * 5)));
                let levelText = pct > 70 ? "–í—ã—Å–æ–∫–∏–π" : pct < 30 ? "–ù–∏–∑–∫–∏–π" : "–°—Ä–µ–¥–Ω–∏–π";

                html += `<div class="res-item">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <strong>${o.name}</strong>
                        <span class="badge">${levelText}</span>
                    </div>
                    <div class="res-bar-bg"><div class="res-bar-fill" style="width:${pct}%"></div></div>
                    <small style="color:#64748b; display:block; margin-top:5px;">${o.description}</small>
                </div>`;
            });
        }
        container.innerHTML = html;

        const saveBtn = document.getElementById('saveTestBtn');
        if (saveBtn) {
            saveBtn.innerText = "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫—É";
            saveBtn.disabled = false;
        }
    },

    setView(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(id+'View').classList.add('active');
    },
    
    setLoading(active, msg) {
        if(active) {
            this.setView('loading');
            document.getElementById('loadTitle').innerText = msg;
        }
    },

    openLibrary() {
        if (typeof Storage === 'undefined') return alert("–ú–æ–¥—É–ª—å —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω!");
        const html = Storage.renderLibraryHTML();
        document.getElementById('libraryContent').innerHTML = html;
        this.setView('library');
    },

    saveCurrentTest() {
        const themeName = document.getElementById('themeInput').value || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è";
        const success = Storage.save(this.state.blueprint, this.state.questions, themeName);
        const btn = document.getElementById('saveTestBtn');
        if (success) {
            btn.innerText = "‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!";
            btn.disabled = true;
        } else alert("–≠—Ç–æ—Ç —Ç–µ—Å—Ç —É–∂–µ –µ—Å—Ç—å –≤ –≤–∞—à–µ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–µ.");
    },

    loadSavedTest(id) {
        const test = Storage.getById(id);
        if (!test) return alert("–¢–µ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω!");
        this.state.blueprint = test.blueprint;
        this.state.questions = test.questions;
        this.state.step = 0;
        this.state.answers = [];
        this.renderQ();
        this.setView('test');
    },

    deleteTest(id) {
        if(confirm("–£–¥–∞–ª–∏—Ç—å?")) {
            Storage.delete(id);
            this.openLibrary();
        }
    }
};

document.getElementById('setupForm').addEventListener('submit', (e) => app.start(e));
</script>

</body>
</html>
