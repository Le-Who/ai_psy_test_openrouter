<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ï–≤–¥–æ–∫–∏—è –¢–µ—Å—Ç–∏–∫–æ–≤–∞</title>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text: #1e293b;
            --text-light: #64748b;
            --border: #e2e8f0;
            --radius: 12px;
        }

        * { box-sizing: border-box; }
        body { margin: 0; font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; }

        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        
        /* UI Components */
        .card { background: var(--surface); padding: 30px; border-radius: var(--radius); box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid var(--border); }
        .btn { background: var(--primary); color: white; border: none; padding: 12px; width: 100%; border-radius: 8px; font-weight: 600; cursor: pointer; transition: opacity 0.2s; }
        .btn:hover { opacity: 0.9; }
        .btn:disabled { opacity: 0.6; cursor: wait; }
        
        input, select { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid var(--border); border-radius: 8px; }
        label { font-weight: 600; font-size: 14px; display: block; margin-top: 15px; }

        /* Views */
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Test UI */
        .likert-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin: 25px 0; }
        .likert-opt { border: 2px solid var(--border); padding: 15px; text-align: center; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .likert-opt:hover { border-color: var(--primary); background: #eff6ff; }
        .likert-opt.selected { background: var(--primary); color: white; border-color: var(--primary); }

        .progress { height: 6px; background: var(--border); border-radius: 99px; overflow: hidden; margin-bottom: 20px; }
        .bar { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s; }

        /* Results */
        .res-item { margin-bottom: 15px; }
        .res-bar-bg { background: #f1f5f9; height: 8px; border-radius: 4px; overflow: hidden; margin-top: 5px; }
        .res-bar-fill { background: var(--primary); height: 100%; }

        /* Loading */
        .loader { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s infinite; margin: 0 auto 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <div style="text-align: center; margin-bottom: 30px;">
        <h1>üîÆ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –¢–µ—Å—Ç–æ–≤ –∏–º–µ–Ω–∏ –î—É–Ω–∏ –ü–∞—Ö—É—á–µ–π <span class="badge">üíÖ</span></h1>
        <div style="font-size: 12px; color: var(--color-text-secondary);">–ü–æ–≤–µ—Ä–µ–¥ –±–∞–π –•–ª–æ–ø—å—è —Å –º–æ–ª–æ–∫–æ–º</div>
    </div>

    <div id="errorBox" style="background:#fef2f2; color:#991b1b; padding:15px; border-radius:8px; display:none; margin-bottom:20px;"></div>

    <!-- VIEW: SETUP (–≠–ö–†–ê–ù –ù–ê–°–¢–†–û–ï–ö) -->
    <div id="setupView" class="view active">
        
        <!-- –í–°–¢–ê–í–ö–ê 1: –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫—É -->
        <div style="display: flex; justify-content: flex-end; margin-bottom: 10px;">
            <button onclick="app.openLibrary()" style="background:none; border:none; color:var(--primary); font-weight:bold; cursor:pointer; display:flex; align-items:center; gap:5px; font-size:14px;">
                üìÇ –ú–æ—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞
            </button>
        </div>
        <!-- –ö–æ–Ω–µ—Ü –≤—Å—Ç–∞–≤–∫–∏ 1 -->

        <div class="card">
             <h2 style="margin-top: 0;">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ç–µ—Å—Ç</h2>
            <p style="color: var(--color-text-secondary); margin-bottom: 24px;">
                –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–µ—Ä–µ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ (OpenRouter –∏–ª–∏ Gemini) –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–∞—à–µ–≥–æ –∫–ª—é—á–∞.
            </p>
            <form id="setupForm">
                <div class="form-group">
                    <label>–¢–µ–º–∞ —Ç–µ—Å—Ç–∞</label>
                    <input type="text" id="themeInput" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö—Ç–æ —Ç—ã –∏–∑ –°–º–µ—à–∞—Ä–∏–∫–æ–≤? –∏–ª–∏ –£—Ä–æ–≤–µ–Ω—å –≤—ã–≥–æ—Ä–∞–Ω–∏—è" required>
                </div>
                <div class="form-group">
                    <label>–ê—É–¥–∏—Ç–æ—Ä–∏—è</label>
                    <input type="text" id="audienceInput" value="–û–±—â–∞—è" placeholder="–î–ª—è –∫–æ–≥–æ —ç—Ç–æ—Ç —Ç–µ—Å—Ç?">
                </div>
                <div class="form-group">
                    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–ø—Ä–æ—Å–æ–≤</label>
                    <select id="qCountInput">
                        <option value="5">5 (–ó–∞—á–µ–º?)</option>
                        <option value="10">10 (–ë—ã—Å—Ç—Ä—ã–π)</option>
                        <option value="15">15 (–û–±—ã—á–Ω—ã–π)</option>
                        <option value="25">25 (–ü–æ–¥—Ä–æ–±–Ω—ã–π)</option>
                        <option value="69">69 (–í–∏—Ä—Ç?)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>API Key</label>
                    <input type="password" id="apiKeyInput" placeholder="sk-or-... (OpenRouter) –∏–ª–∏ AIza... (Gemini)" required>
                    <div class="hint">–ö–ª—é—á –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∫–∞–∫–∞—è –º–æ–¥–µ–ª—å –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞.</div>
                </div>
                <button type="submit" class="btn">üöÄ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
            </form>
        </div>
    </div>

    <!-- –í–°–¢–ê–í–ö–ê 2: –ù–û–í–´–ô –≠–ö–†–ê–ù –ë–ò–ë–õ–ò–û–¢–ï–ö–ò -->
    <div id="libraryView" class="view">
        <div id="libraryContent">
            <!-- –°—é–¥–∞ JavaScript –±—É–¥–µ—Ç –≤—Å—Ç–∞–≤–ª—è—Ç—å —Å–ø–∏—Å–æ–∫ —Ç–µ—Å—Ç–æ–≤ -->
        </div>
    </div>
    <!-- –ö–æ–Ω–µ—Ü –≤—Å—Ç–∞–≤–∫–∏ 2 -->


    <!-- LOADING -->
    <div id="loadingView" class="view" style="text-align: center; padding-top: 50px;">
        <div class="loader"></div>
        <h3 id="loadTitle">–ó–∞–ø—É—Å–∫...</h3>
        <p id="loadDesc" style="color: var(--text-light);">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–µ–ª–µ–π</p>
    </div>

    <!-- TEST -->
    <div id="testView" class="view">
        <div class="progress"><div id="progressBar" class="bar"></div></div>
        <div class="card">
            <div style="font-size: 12px; color: var(--text-light); margin-bottom: 10px;">–í–û–ü–†–û–° <span id="qNum">1</span></div>
            <h3 id="qText" style="font-size: 20px; margin-bottom: 30px;">...</h3>
            
            <div class="likert-grid">
                <div class="likert-opt" onclick="app.answer(1)">1</div>
                <div class="likert-opt" onclick="app.answer(2)">2</div>
                <div class="likert-opt" onclick="app.answer(3)">3</div>
                <div class="likert-opt" onclick="app.answer(4)">4</div>
                <div class="likert-opt" onclick="app.answer(5)">5</div>
            </div>
            <div style="display:flex; justify-content:space-between; font-size:12px; color:var(--text-light); padding:0 5px;">
                <span>–ù–µ—Ç / –ù–∏–∫–æ–≥–¥–∞</span>
                <span>–î–∞ / –í—Å–µ–≥–¥–∞</span>
            </div>
        </div>
    </div>

    <!-- VIEW: RESULTS -->
    <div id="resultsView" class="view">
        <div class="card" id="resultsContent"></div>
        
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <!-- –ö–Ω–æ–ø–∫–∞ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ -->
            <button class="btn" onclick="location.reload()" style="flex: 1;">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π</button>
            
            <!-- –ö–ù–û–ü–ö–ê –°–û–•–†–ê–ù–ï–ù–ò–Ø (–ù–æ–≤–∞—è) -->
            <button class="btn btn-secondary" id="saveTestBtn" onclick="app.saveCurrentTest()" style="flex: 1;">
                üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫—É
            </button>
        </div>
    </div>

<script src="app-settings.js"></script>
<script>
// --- –ü–ê–¢–ß –ö–û–ù–§–ò–ì–ê ---
// –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å—Ç–∞–≤–∏–º –Ω—É–∂–Ω—ã–µ –º–æ–¥–µ–ª–∏, –∏–≥–Ω–æ—Ä–∏—Ä—É—è —Ç–æ, —á—Ç–æ –≤ —Ñ–∞–π–ª–µ
if (typeof CONFIG !== 'undefined') {
    CONFIG.providers = CONFIG.providers || {};
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ OpenRouter
    CONFIG.providers.openrouter = {
        endpoint: 'https://openrouter.ai/api/v1/chat/completions',
        models: {
            architect: 'xiaomi/mimo-v2-flash:free',
            generator: 'xiaomi/mimo-v2-flash:free'
        },
        headers: (key) => ({
            'Authorization': `Bearer ${key}`,
            'Content-Type': 'application/json',
            'HTTP-Referer': window.location.href,
        })
    };
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Gemini
    CONFIG.providers.gemini = {
        endpoint: 'https://generativelanguage.googleapis.com/v1beta/models/',
        models: {
            architect: 'gemini-2.5-flash', // –ê–∫—Ç—É–∞–ª—å–Ω–∞—è –±—ã—Å—Ç—Ä–∞—è –≤–µ—Ä—Å–∏—è
            generator: 'gemini-2.5-flash'
        }
    };
} else {
    alert("–û—à–∏–±–∫–∞: app-settings.js –Ω–µ –Ω–∞–π–¥–µ–Ω!");
}

const api = {
    detectProvider(key) {
        return key.startsWith('AIza') ? 'gemini' : 'openrouter';
    },

    // –ü–∞—Ä—Å–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–∂–∏–≤–∞–µ—Ç –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –º–æ–¥–µ–ª–∏
    safeParseJSON(text) {
        try {
            return JSON.parse(text);
        } catch (e) {
            console.warn("JSON parse fail, trying regex...");
            // –ò—â–µ–º { ... } –∏–ª–∏ [ ... ]
            const match = text.match(/(\{[\s\S]*\}|\[[\s\S]*\])/);
            if (match) {
                try { return JSON.parse(match[0]); } catch (e2) {}
            }
            // –ï—Å–ª–∏ –º–æ–¥–µ–ª—å –≤–µ—Ä–Ω—É–ª–∞ Markdown ```json ... ```
            const mdMatch = text.match(/```(?:json)?\s*([\s\S]*?)\s*```/);
            if (mdMatch) {
                try { return JSON.parse(mdMatch[1]); } catch (e3) {}
            }
            throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞ –º–æ–¥–µ–ª–∏: " + text.substring(0, 50) + "...");
        }
    },

    async call(systemPrompt, userPrompt, schema, modelType, apiKey) {
        const provider = this.detectProvider(apiKey);
        console.log(`üì° API: ${provider} -> ${modelType}`);

        // –î–ª—è OpenRouter (Xiaomi) –æ—Ç–∫–ª—é—á–∞–µ–º strict mode, –æ–Ω –ª–æ–º–∞–µ—Ç free –º–æ–¥–µ–ª–∏
        // –î–ª—è Gemini —á–∏—Å—Ç–∏–º —Å—Ö–µ–º—É
        const cleanSchema = this.prepareSchema(schema, provider);

        if (provider === 'gemini') {
            return this.callGemini(systemPrompt, userPrompt, cleanSchema, modelType, apiKey);
        } else {
            return this.callOpenRouter(systemPrompt, userPrompt, cleanSchema, modelType, apiKey);
        }
    },

    prepareSchema(schema, provider) {
        let s = JSON.parse(JSON.stringify(schema));
        if (s.json_schema && s.json_schema.schema) s = s.json_schema.schema; // Unwrap

        // –†–µ–∫—É—Ä—Å–∏–≤–Ω–∞—è —á–∏—Å—Ç–∫–∞
        const clean = (obj) => {
            if (!obj || typeof obj !== 'object') return;
            // Gemini –∏ Xiaomi Free –Ω–µ –ª—é–±—è—Ç additionalProperties
            if ('additionalProperties' in obj) delete obj.additionalProperties;
            if (obj.properties) Object.values(obj.properties).forEach(clean);
            if (obj.items) clean(obj.items);
        };
        clean(s);
        return s;
    },

    async callOpenRouter(sys, user, schema, type, key) {
        const model = CONFIG.providers.openrouter.models[type];
        
        try {
            const res = await fetch(CONFIG.providers.openrouter.endpoint, {
                method: 'POST',
                headers: CONFIG.providers.openrouter.headers(key),
                body: JSON.stringify({
                    model: model,
                    messages: [{role: 'system', content: sys}, {role: 'user', content: user}],
                    // –í–∞–∂–Ω–æ: Xiaomi Free –º–æ–∂–µ—Ç –ø–∞–¥–∞—Ç—å –µ—Å–ª–∏ response_format —Å–ª–æ–∂–Ω—ã–π
                    // –ü–æ—Å—ã–ª–∞–µ–º –µ–≥–æ, –Ω–æ –µ—Å–ª–∏ –æ—à–∏–±–∫–∞ 400 - –ø—Ä–æ–±—É–µ–º –±–µ–∑ –Ω–µ–≥–æ –≤ catch?
                    // –ü–æ–∫–∞ —à–ª–µ–º –∫–∞–∫ –µ—Å—Ç—å, –Ω–æ schema –æ—á–∏—â–µ–Ω–∞.
                    response_format: { type: "json_object" }, // –£–ø—Ä–æ—â–∞–µ–º –¥–æ json_object
                    temperature: 0.7
                })
            });
            
            if (!res.ok) {
                const err = await res.json();
                throw new Error(err.error?.message || 'API Error');
            }
            
            const data = await res.json();
            return this.safeParseJSON(data.choices[0].message.content);

        } catch (e) {
            console.error("OR Error:", e);
            throw e;
        }
    },

    async callGemini(sys, user, schema, type, key) {
        const model = CONFIG.providers.gemini.models[type];
        const url = `${CONFIG.providers.gemini.endpoint}${model}:generateContent?key=${key}`;

        // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –ø—Ä–æ JSON –≤ –ø—Ä–æ–º–ø—Ç, —Ç–∞–∫ –Ω–∞–¥–µ–∂–Ω–µ–µ –¥–ª—è Gemini
        const prompt = `${sys}\n\n–û–¢–í–ï–¢–¨ –°–¢–†–û–ì–û –í FORMAT JSON, –°–û–ì–õ–ê–°–ù–û –°–•–ï–ú–ï:\n${JSON.stringify(schema)}\n\n–ó–ê–î–ê–ß–ê: ${user}`;

        const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    temperature: 0.7,
                    response_mime_type: "application/json"
                }
            })
        });

        if (!res.ok) {
            const err = await res.json();
            throw new Error(err.error?.message || 'Gemini Error');
        }

        const data = await res.json();
        return this.safeParseJSON(data.candidates[0].content.parts[0].text);
    }
};

<script src="storage.js"></script>

<script>
// --- APP LOGIC ---
const app = {
    state: { step: 0, answers: [], questions: [], blueprint: {}, apiKey: '' },

    async start(e) {
        e.preventDefault();
        this.state.apiKey = document.getElementById('apiKeyInput').value;
        const theme = document.getElementById('themeInput').value;
        const count = document.getElementById('qCountInput').value;

        if(!this.state.apiKey) return alert("–ù—É–∂–µ–Ω –∫–ª—é—á!");

        this.setLoading(true, "–ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä –ø–ª–∞–Ω–∏—Ä—É–µ—Ç —Ç–µ—Å—Ç...");
        document.getElementById('errorBox').style.display = 'none';

        try {
            // 1. Blueprint (–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–∞)
            const blueprint = await api.call(
                PROMPTS.architect,
                `–¢–µ–º–∞: "${theme}". –ü—Ä–∏–¥—É–º–∞–π —Å—Ç—Ä—É–∫—Ç—É—Ä—É.`,
                SCHEMAS.blueprint,
                'architect',
                this.state.apiKey
            );
            this.state.blueprint = blueprint;

            // 2. Questions (–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤)
            this.setLoading(true, "–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø–∏—à–µ—Ç –≤–æ–ø—Ä–æ—Å—ã...");
            
            const genPrompt = `–¢–µ–º–∞: ${theme}. –¢–∏–ø: ${blueprint.testType}.
            –†–µ–∑—É–ª—å—Ç–∞—Ç—ã: ${JSON.stringify(blueprint.outcomes)}.
            –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π ${count} –≤–æ–ø—Ä–æ—Å–æ–≤.
            
            –í–ê–ñ–ù–û –ü–†–û –í–ï–°–ê:
            –ù–µ –¥–µ–ª–∞–π —Ç–∞–∫, —á—Ç–æ–±—ã –æ–¥–∏–Ω –≤–æ–ø—Ä–æ—Å –¥–∞–≤–∞–ª –±–∞–ª–ª—ã —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ–º—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É.
            –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–π –≤–µ—Å–∞! –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å "–Ø –ª—é–±–ª—é —à—É–º", —ç—Ç–æ:
            - –®—É–º–Ω—ã–π –ø–µ—Ä—Å–æ–Ω–∞–∂: +1.0
            - –¢–∏—Ö–∏–π –ø–µ—Ä—Å–æ–Ω–∞–∂: -1.0
            - –°—Ä–µ–¥–Ω–∏–π –ø–µ—Ä—Å–æ–Ω–∞–∂: +0.2`;

            const content = await api.call(
                PROMPTS.generator,
                genPrompt,
                SCHEMAS.questions,
                'generator',
                this.state.apiKey
            );
            
            this.state.questions = content.questions;
            
            // –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞
            this.state.step = 0;
            this.state.answers = [];
            this.renderQ();
            this.setView('test');

        } catch (err) {
            document.getElementById('errorBox').style.display = 'block';
            document.getElementById('errorBox').innerText = "–û—à–∏–±–∫–∞: " + err.message;
            this.setView('setup');
        }
    },

    renderQ() {
        const q = this.state.questions[this.state.step];
        document.getElementById('qNum').innerText = `${this.state.step + 1} / ${this.state.questions.length}`;
        document.getElementById('qText').innerText = q.text;
        
        const pct = (this.state.step / this.state.questions.length) * 100;
        document.getElementById('progressBar').style.width = pct + '%';
        
        document.querySelectorAll('.likert-opt').forEach(d => d.classList.remove('selected'));
    },

    answer(val) {
        this.state.answers[this.state.step] = val;
        document.querySelectorAll('.likert-opt')[val-1].classList.add('selected');
        
        setTimeout(() => {
            this.state.step++;
            if(this.state.step < this.state.questions.length) {
                this.renderQ();
            } else {
                this.finish();
            }
        }, 200);
    },

    finish() {
        this.setLoading(true, "–°—á–∏—Ç–∞–µ–º –∏—Ç–æ–≥–∏...");
        this.setView('loading');
        
        setTimeout(() => {
            this.calc();
            this.setView('results');
        }, 500);
    },

    calc() {
        const scores = {};
        this.state.blueprint.outcomes.forEach(o => scores[o.id] = 0);

        this.state.questions.forEach((q, idx) => {
            const userVal = this.state.answers[idx] - 3; // -2..+2
            q.mapping.forEach(m => {
                if(scores[m.outcomeId] !== undefined) {
                    scores[m.outcomeId] += (m.weight * userVal);
                }
            });
        });

        // Render Results
        const container = document.getElementById('resContent');
        let html = '';
        
        if(this.state.blueprint.testType === 'categorical') {
            const sorted = this.state.blueprint.outcomes.sort((a,b) => scores[b.id] - scores[a.id]);
            const win = sorted[0];
            const max = Math.max(...Object.values(scores), 1); 

            html = `<div style="text-align:center">
                <h2>${win.name}</h2>
                <p>${win.description}</p>
            </div><hr style="margin:20px 0; border:0; border-top:1px solid #eee">`;
            
            sorted.slice(1).forEach(o => {
                let pct = 0;
                if(max > 0) pct = Math.max(0, (scores[o.id] / max) * 100);
                
                html += `<div class="res-item">
                    <div style="display:flex; justify-content:space-between; font-size:14px;">
                        <span>${o.name}</span>
                    </div>
                    <div class="res-bar-bg"><div class="res-bar-fill" style="width:${pct}%"></div></div>
                </div>`;
            });
        } else {
            this.state.blueprint.outcomes.forEach(o => {
                const s = scores[o.id];
                const pct = Math.min(100, Math.max(0, 50 + (s * 5)));
                html += `<div class="res-item">
                    <strong>${o.name}</strong>
                    <div class="res-bar-bg"><div class="res-bar-fill" style="width:${pct}%"></div></div>
                    <small style="color:#666">${o.description}</small>
                </div>`;
            });
        }
        container.innerHTML = html;

        // Reset Save Button (–≤–∞–∂–Ω–æ –¥–ª—è –ø–µ—Ä–µ–ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è)
        const saveBtn = document.getElementById('saveTestBtn');
        if (saveBtn) {
            saveBtn.innerHTML = "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫—É";
            saveBtn.disabled = false;
        }
    },

    setView(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(id+'View').classList.add('active');
    },
    
    setLoading(active, msg) {
        if(active) {
            this.setView('loading');
            document.getElementById('loadTitle').innerText = msg;
        }
    },

    // === –ù–û–í–´–ï –ú–ï–¢–û–î–´ (LIBRARY) ===

    openLibrary() {
        const html = Storage.renderLibraryHTML();
        document.getElementById('libraryContent').innerHTML = html;
        this.setView('library');
    },

    saveCurrentTest() {
        const themeName = document.getElementById('themeInput').value || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è";
        const success = Storage.save(this.state.blueprint, this.state.questions, themeName);
        
        const btn = document.getElementById('saveTestBtn');
        if (success) {
            btn.innerHTML = "‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!";
            btn.disabled = true;
        } else {
            alert("–û—à–∏–±–∫–∞: —ç—Ç–æ—Ç —Ç–µ—Å—Ç —É–∂–µ –µ—Å—Ç—å –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ.");
        }
    },

    loadSavedTest(id) {
        const test = Storage.getById(id);
        if (!test) return alert("–¢–µ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω!");

        this.state.blueprint = test.blueprint;
        this.state.questions = test.questions;
        
        // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫
        this.state.step = 0;
        this.state.answers = [];
        this.renderQ();
        this.setView('test');
    },

    deleteTest(id) {
        if(confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–µ—Å—Ç –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏?")) {
            Storage.delete(id);
            this.openLibrary(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
        }
    }
};

// –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã
document.getElementById('setupForm').addEventListener('submit', (e) => app.start(e));
</script>
</body>
</html>
