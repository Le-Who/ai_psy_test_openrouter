<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ï–≤–¥–æ–∫–∏—è –¢–µ—Å—Ç–∏–∫–æ–≤–∞</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="container">
    
    <!-- HEADER -->
    <div class="header-row">
        <div class="header-content">
            <h1 style="cursor: pointer;" onclick="location.reload()" title="–î–æ–º –î—É–Ω–∏">
    üîÆ <span class="header-title-text">–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –¢–µ—Å—Ç–æ–≤ –∏–º. –î—É–Ω–∏ –ü–∞—Ö—É—á–µ–π</span> üíÖ</h1>
            <p>–†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —Ö–ª–æ–ø—å—è—Ö —Å –º–æ–ª–æ–∫–æ–º ü•£</p>
        </div>

        <button class="theme-toggle-btn" onclick="toggleThemeMenu()" title="–¢–µ–º—ã –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è">
            üé®
        </button>

        <div class="theme-menu" id="themeMenu">
            <div class="theme-opt" onclick="setTheme('light')">
                <div class="theme-circle" style="background: #fff; border: 1px solid #ddd;"></div>
                –°–≤–µ—Ç–ª–µ–Ω—å–∫–∞—è
            </div>
            <div class="theme-opt" onclick="setTheme('dark')">
                <div class="theme-circle" style="background: #1e293b;"></div>
                –¢–µ–º–Ω–µ–Ω—å–∫–∞—è
            </div>
            <div class="theme-opt" onclick="setTheme('gray')">
                <div class="theme-circle" style="background: #e5e5e5; border: 1px solid #999;"></div>
                –°–µ—Ä–µ–Ω—å–∫–∞—è
            </div>
        </div>
    </div>
    
    <div id="errorBox" style="background:#fef2f2; color:#991b1b; padding:15px; border-radius:12px; display:none; margin-bottom:20px; border:1px solid #fecaca;"></div>

    <!-- 1. VIEW: SETUP -->
    <div id="setupView" class="view active">
        <div style="display: flex; justify-content: flex-end; margin-bottom: 10px;">
            <button onclick="app.openLibrary()" class="btn-text">üìÇ –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</button>
        </div>

        <div class="card">
            <!-- HEADER WITH TABS -->
            <div class="card-header-row">
                <h2 class="card-title">–ù–æ–≤—ã–π —Ç–µ—Å—Ç</h2>
                <div class="mode-tabs">
                    <button class="mode-tab active" id="tabPsy" onclick="app.setMode('psy')">–¢–µ—Å—Ç–∏–∫—É–ª</button>
                    <button class="mode-tab" id="tabQuiz" onclick="app.setMode('quiz')">–í–∏–∫—Ç–æ—Ä–∏—è</button>
                </div>
            </div>

            <form id="setupForm">
                <label>–¢–µ–º–∞</label>
                <input type="text" id="themeInput" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ó–Ω–∞—Ç–æ–∫ –º–µ–º–æ–≤ 2025" required>
                
                <label>–£—Ç–æ—á–Ω–µ–Ω–∏—è <span style="font-weight:normal; opacity:0.7; font-size:12px;">(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</span></label>
                <textarea id="notesInput" rows="2" style="width:100%; padding:12px; margin-top:8px; border:1px solid var(--border); border-radius:10px; background:var(--bg); color:var(--text); font-family:inherit; resize:vertical;" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ò—Å–ø–æ–ª—å–∑—É–π —Å–ª–µ–Ω–≥, –¥–µ–ª–∞–π –≤–æ–ø—Ä–æ—Å—ã —Å —á–µ—Ä–Ω—ã–º —é–º–æ—Ä–æ–º, —Å—Å—ã–ª–∞–π—Å—è –Ω–∞ –ª–æ—Ä –∫–Ω–∏–≥..."></textarea>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <!-- –û–ü–¶–ò–ò –î–õ–Ø PSY -->
                    <div id="audienceGroup">
                        <label>–ê—É–¥–∏—Ç–æ—Ä–∏—è</label>
                        <input type="text" id="audienceInput" value="–û–±—â–∞—è" placeholder="–ö—Ç–æ –ø—Ä–æ—Ö–æ–¥–∏—Ç?">
                    </div>
                    
                    <!-- –û–ü–¶–ò–ò –î–õ–Ø QUIZ (–°–∫—Ä—ã—Ç—ã –ø–æ –¥–µ—Ñ–æ–ª—Ç—É) -->
                    <div id="difficultyGroup" style="display:none;">
                        <label>–í–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∞</label>
                        <select id="difficultyInput">
                            <option value="2">2 (–î–∞/–ù–µ—Ç)</option>
                            <option value="3">3 (–õ–µ–≥–∫–æ)</option>
                            <option value="4" selected>4 (–°—Ç–∞–Ω–¥–∞—Ä—Ç)</option>
                        </select>
                    </div>

                    <div>
                        <label>–í–æ–ø—Ä–æ—Å–æ–≤</label>
                        <select id="qCountInput">
                            <option value="5">5</option>
                            <option value="10" selected>10</option>
                            <option value="15">15</option>
                            <option value="20">20</option>
                        </select>
                    </div>
                </div>

                <label>API –ö–ª—é—á</label>
                <input type="password" id="apiKeyInput" placeholder="sk-or-... –∏–ª–∏ AIza..." required>
                
                <button type="submit" class="btn" style="margin-top: 25px;">üöÄ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
            </form>
        </div>
    </div>

    <!-- 2. VIEW: LIBRARY -->
    <div id="libraryView" class="view">
        <div id="libraryContent"></div>
    </div>

    <!-- 3. VIEW: LOADING -->
    <div id="loadingView" class="view" style="text-align: center; padding-top: 50px;">
        <div class="loader"></div>
        <h3 id="loadTitle">–ó–∞–ø—É—Å–∫...</h3>
        <p id="loadDesc" style="color: var(--text-muted);">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–µ–ª–µ–π</p>
    </div>

    <!-- 4. VIEW: TEST -->
    <div id="testView" class="view">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom: 15px;">
            <button id="backBtn" class="btn-back" onclick="app.prevQuestion()">‚Üê –ù–∞–∑–∞–¥</button>
            <div style="color: var(--text-muted); font-size: 13px; font-weight: 600;">
                –í–û–ü–†–û–° <span id="qNum">1</span>
            </div>
        </div>

        <div class="progress"><div id="progressBar" class="bar"></div></div>
        
        <div class="card">
            <h3 id="qText" style="font-size: 22px; margin-bottom: 30px; line-height: 1.4;">...</h3>
            
            <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è PSY (1-5) -->
            <div id="psyContainer" class="likert-grid">
                <div class="likert-opt" onclick="app.answer(1)">1</div>
                <div class="likert-opt" onclick="app.answer(2)">2</div>
                <div class="likert-opt" onclick="app.answer(3)">3</div>
                <div class="likert-opt" onclick="app.answer(4)">4</div>
                <div class="likert-opt" onclick="app.answer(5)">5</div>
                <div style="grid-column:1/-1; display:flex; justify-content:space-between; font-size:13px; color:var(--text-muted); margin-top:5px;">
                    <span>‚ùå –ù–µ—Ç</span><span>‚úÖ –î–∞</span>
                </div>
            </div>

            <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è QUIZ (–ö–Ω–æ–ø–∫–∏) -->
            <div id="quizContainer" class="quiz-grid" style="display:none;">
                <!-- JS —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–Ω–æ–ø–∫–∏ –∑–¥–µ—Å—å -->
            </div>

            <!-- –ö–Ω–æ–ø–∫–∞ "–î–∞–ª–µ–µ" –¥–ª—è QUIZ -->
            <div id="nextBtnContainer" class="next-btn-container" style="display:none;">
                <button class="btn-next" onclick="app.nextQuestion()">–°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å ‚Üí</button>
            </div>
        </div>
    </div>

    <!-- 5. VIEW: RESULTS -->
    <div id="resultsView" class="view">
        <div class="card" id="resContent"></div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <button class="btn" onclick="location.reload()">‚Ü∫ –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π</button>
            <button class="btn btn-secondary" id="saveTestBtn" onclick="app.saveCurrentTest()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫—É</button>
        </div>
    </div>
</div>

<!-- –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –°–ö–†–ò–ü–¢–û–í -->
<script src="app-settings.js"></script> <!-- 1. –ö–æ–Ω—Ñ–∏–≥ -->
<script src="storage.js"></script>      <!-- 2. –•—Ä–∞–Ω–∏–ª–∏—â–µ -->
<script src="app.js"></script>          <!-- 3. –õ–æ–≥–∏–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (api + app) -->

<!-- –õ–û–ì–ò–ö–ê –¢–ï–ú–´ (UI Only) -->
<script>
    function toggleThemeMenu() {
        const menu = document.getElementById('themeMenu');
        menu.classList.toggle('active');
        if (menu.classList.contains('active')) {
            setTimeout(() => document.addEventListener('click', closeMenuOutside), 10);
        }
    }

    function closeMenuOutside(e) {
        if (!e.target.closest('.theme-menu') && !e.target.closest('.theme-toggle-btn')) {
            document.getElementById('themeMenu').classList.remove('active');
            document.removeEventListener('click', closeMenuOutside);
        }
    }

    function setTheme(themeName) {
        if (themeName === 'light') {
            document.body.removeAttribute('data-theme');
        } else {
            document.body.setAttribute('data-theme', themeName);
        }
        localStorage.setItem('user_theme', themeName);
        document.getElementById('themeMenu').classList.remove('active');
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    (function initTheme() {
        const saved = localStorage.getItem('user_theme');
        if (saved) setTheme(saved);
        else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            setTheme('dark');
        }
    })();
</script>

</body>
</html>
