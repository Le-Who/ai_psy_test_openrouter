<!DOCTYPE html>
<html lang="ru">
<head>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Nunito:wght@700;800;900&display=swap" rel="stylesheet">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ï–≤–¥–æ–∫–∏—è –¢–µ—Å—Ç–∏–∫–æ–≤–∞</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div class="container">
        <!-- HEADER -->
        <div class="header-row">
            <div class="header-content">
             <h1 style="cursor: pointer;" onclick="location.reload()" title="–î–æ–º –î—É–Ω–∏">
    üîÆ <span class="header-title-text">–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –¢–µ—Å—Ç–æ–≤ –∏–º. –î—É–Ω–∏ –ü–∞—Ö—É—á–µ–π</span> üíÖ</h1>
            <p>–†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —Ö–ª–æ–ø—å—è—Ö —Å –º–æ–ª–æ–∫–æ–º ü•£</p>
            </div>
            
            <button class="theme-toggle-btn" onclick="toggleThemeMenu()" title="–¢–µ–º—ã" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É" aria-expanded="false">üé®</button>
            <div class="theme-menu" id="themeMenu">
                <button class="theme-opt" onclick="setTheme('light')"><div class="theme-circle" style="background: #fff; border: 1px solid #ddd;"></div> –°–≤–µ—Ç–ª–µ–Ω—å–∫–∞—è</button>
                <button class="theme-opt" onclick="setTheme('dark')"><div class="theme-circle" style="background: #1e293b;"></div> –¢–µ–º–Ω–µ–Ω—å–∫–∞—è</button>
                <button class="theme-opt" onclick="setTheme('gray')"><div class="theme-circle" style="background: #e5e5e5; border: 1px solid #999;"></div> –°–µ—Ä–µ–Ω—å–∫–∞—è</button>
            </div>
        </div>

        <div id="errorBox" style="background:#fef2f2; color:#991b1b; padding:15px; border-radius:12px; display:none; margin-bottom:20px; border:1px solid #fecaca;"></div>

        <!-- 1. SETUP VIEW -->
        <div id="setupView" class="view active">
            <div style="display: flex; justify-content: flex-end; margin-bottom: 10px;">
                <button id="openLibraryBtn" onclick="app.openLibrary()" class="btn-text">üìÇ –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</button>
            </div>

            <div class="card">
                <div class="card-header-row">
                    <h2 class="card-title">–ù–æ–≤—ã–π —Ç–µ—Å—Ç</h2>
                    <div class="mode-tabs">
                        <button class="mode-tab active" id="tabPsy" onclick="app.setMode('psy')">–¢–µ—Å—Ç–∏–∫—É–ª</button>
                        <button class="mode-tab" id="tabQuiz" onclick="app.setMode('quiz')">–í–∏–∫—Ç–æ—Ä–∏—è</button>
                    </div>
                </div>

                <form onsubmit="app.start(event)" novalidate>
                    <label>–¢–µ–º–∞ <span class="text-danger" style="margin-left:3px;" aria-hidden="true">*</span></label>
                    <input type="text" id="themeInput" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö–∞–∫–æ–π —Ç—ã —Ö–ª–µ–±—É—à–µ–∫?" required>

                    <label>–£—Ç–æ—á–Ω–µ–Ω–∏—è <span style="font-weight:normal; opacity:0.7; font-size:12px;">(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</span></label>
                    <textarea id="notesInput" rows="2" style="width:100%; padding:12px; margin-top:8px; border:1px solid var(--border); border-radius:10px; background:var(--bg); color:var(--text); font-family:inherit; resize:vertical;" placeholder="–°–¥–µ–ª–∞–π —Å–º–µ—à–Ω—ã–º, –¥–ª—è –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–æ–≤..."></textarea>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div id="audienceGroup">
                            <label>–ê—É–¥–∏—Ç–æ—Ä–∏—è</label>
                            <input type="text" id="audienceInput" value="" placeholder="–ü–æ–¥—Ä–æ—Å—Ç–∫–∏?">
                        </div>
                        <div id="difficultyGroup" style="display:none;">
                            <label>–í–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∞</label>
                            <select id="difficultyInput">
                                <option value="2">2 (–î–∞/–ù–µ—Ç)</option>
                                <option value="3">3 (–õ–µ–≥–∫–æ)</option>
                                <option value="4" selected>4 (–°—Ç–∞–Ω–¥–∞—Ä—Ç)</option>
                            </select>
                        </div>

                        <div>
                            <label>–í–æ–ø—Ä–æ—Å–æ–≤</label>
                        <select id="qCountInput">
                            <option value="5">5</option>
                            <option value="10" selected>10</option>
                            <option value="15">15</option>
                            <option value="20">20</option>
                            <option value="30">30</option>
                            <option value="50">50</option>
                            <option value="69">–¢—É–º–∞—á.</option>
                            </select>
                        </div>
                    </div>

                    <label>API –ö–ª—é—á <span class="text-danger" style="margin-left:3px;" aria-hidden="true">*</span></label>
                    <div class="input-group">
                        <input type="password" id="apiKeyInput" placeholder="sk-or-... / AIza..." required>
                        <button type="button" class="password-toggle" aria-label="–ü–æ–∫–∞–∑–∞—Ç—å API –∫–ª—é—á" onclick="togglePasswordVisibility('apiKeyInput', this)">
                            üëÅÔ∏è
                        </button>
                    </div>

                    <button type="submit" class="btn primary-btn" style="margin-top: 25px;">
                        üöÄ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                </form>
            </div>
        </div>

        <!-- 2. LIBRARY VIEW -->
        <div id="libraryView" class="view">
            <div style="margin-bottom:20px;">
                <button id="closeLibraryBtn" onclick="app.closeLibrary()" class="btn-text">‚Üê –ù–∞–∑–∞–¥</button>
            </div>
            <h2>–í–∞—à–∏ —Ç–µ—Å—Ç—ã</h2>
            <div id="libraryContent"></div> <!-- –í–ê–ñ–ù–û: ID libraryContent -->
        </div>

        <!-- 3. DUEL VIEW (–≠–∫—Ä–∞–Ω –≤—ã–∑–æ–≤–∞) -->
        <div id="duelView" class="container" style="display: none; text-align: center; padding-top: 50px;">
            <div style="font-size: 60px;">‚öîÔ∏è</div>
            <h1 style="color: var(--primary); margin-bottom: 10px;">–í–´–ó–û–í –ü–†–ò–ù–Ø–¢?</h1>
            <p style="font-size: 18px; color: var(--text-muted); margin-bottom: 30px;">
                –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å <strong id="duelHostName" style="color: #fff;">...</strong> –Ω–∞–±—Ä–∞–ª 
                <strong id="duelHostScore" style="color: var(--accent);">...</strong> –±–∞–ª–ª–æ–≤.
                <br>–°–º–æ–∂–µ—à—å –µ–≥–æ –ø–æ–±–µ–¥–∏—Ç—å?
            </p>
            
            <div class="card" style="margin-bottom: 30px; text-align: left;">
                <h3 id="duelThemeTitle" style="margin-top: 0;">–¢–µ–º–∞...</h3>
                <p>–í–æ–ø—Ä–æ—Å–æ–≤: <span id="duelQCount">...</span></p>
            </div>

            <button class="btn" onclick="app.startDuelTest()" style="font-size: 20px; padding: 15px 40px;">
                üöÄ –ü–†–ò–ù–Ø–¢–¨ –ë–û–ô
            </button>
        </div>

        <!-- 4. TEST VIEW -->
        <div id="testView" class="view">
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom: 15px;">
                <button id="backBtn" class="btn-back" onclick="app.prevQuestion()">‚Üê –ù–∞–∑–∞–¥</button>
                <div style="color: var(--text-muted); font-size: 13px; font-weight: 600;">
                    –í–û–ü–†–û–° <span id="qNum">1</span>
                </div>
            </div>

            <div class="progress-div"><div id="progressBar" class="bar"></div></div>

            <div class="card">
                <h3 id="qText" style="font-size: 22px; margin-bottom: 30px; line-height: 1.4;">...</h3>

                <!-- PSY (Likert 1-5) -->
                <div id="psyContainer" class="likert-grid">
                  <button type="button" class="likert-opt" data-value="1" aria-label="–û—Ü–µ–Ω–∫–∞ 1: –°–æ–≤—Å–µ–º –Ω–µ –ø—Ä–æ –º–µ–Ω—è" aria-pressed="false">
                    <span>1</span><span>–°–æ–≤—Å–µ–º –Ω–µ –ø—Ä–æ –º–µ–Ω—è ü§¨</span>
                  </button>
                  <button type="button" class="likert-opt" data-value="2" aria-label="–û—Ü–µ–Ω–∫–∞ 2: –°–∫–æ—Ä–µ–µ –Ω–µ —Å–æ–≥–ª–∞—Å–µ–Ω" aria-pressed="false">
                    <span>2</span><span>–°–∫–æ—Ä–µ–µ –Ω–µ —Å–æ–≥–ª–∞—Å–µ–Ω üëé</span>
                  </button>
                  <button type="button" class="likert-opt" data-value="3" aria-label="–û—Ü–µ–Ω–∫–∞ 3: –ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ" aria-pressed="false">
                    <span>3</span><span>–ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ üòê</span>
                  </button>
                  <button type="button" class="likert-opt" data-value="4" aria-label="–û—Ü–µ–Ω–∫–∞ 4: –°–∫–æ—Ä–µ–µ —Å–æ–≥–ª–∞—Å–µ–Ω" aria-pressed="false">
                    <span>4</span><span>–°–∫–æ—Ä–µ–µ —Å–æ–≥–ª–∞—Å–µ–Ω üëç</span>
                  </button>
                  <button type="button" class="likert-opt" data-value="5" aria-label="–û—Ü–µ–Ω–∫–∞ 5: –û—á–µ–Ω—å –ø—Ä–æ –º–µ–Ω—è" aria-pressed="false">
                    <span>5</span><span>–û—á–µ–Ω—å –ø—Ä–æ –º–µ–Ω—è üòç</span>
                  </button>
                </div>


                <!-- QUIZ (Grid) -->
                <div id="quizContainer" class="quiz-grid" style="display:none;"></div>
            </div>
            
            <div id="inProgressActions" style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:18px;">
                <button id="inProgressSaveBtn" class="btn" onclick="app.saveTest(this)" style="flex:1;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ—Å—Ç</button>
                <button id="inProgressShareBtn" class="btn btn-accent" onclick="app.createShareLink(this)" style="flex:1;">–°–æ–∑–¥–∞—Ç—å –¥—É—ç–ª—å-—Å—Å—ã–ª–∫—É</button>
            </div>

            <!-- –ö–Ω–æ–ø–∫—É "–î–∞–ª–µ–µ" —É–±—Ä–∞–ª–∏ —Å–æ–≤—Å–µ–º, —Ç–∞–∫ –∫–∞–∫ —Ç–µ–ø–µ—Ä—å –≤–µ–∑–¥–µ –∞–≤—Ç–æ-–ø–µ—Ä–µ—Ö–æ–¥ -->
        </div>

        <!-- 5. RESULTS VIEW -->
        <div id="resultsView" class="view">
            <div class="card" id="resContent"></div>
            
            <div style="text-align:center; margin-top:20px;">
                <button class="btn-text" onclick="location.reload()">‚Ü∫ –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π</button>
            </div>
        </div>
        <div id="toast">–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞! üìã</div>
    </div>

    <!-- –°–ö–†–ò–ü–¢–´ (–ü–æ—Ä—è–¥–æ–∫ –≤–∞–∂–µ–Ω) -->
    <script src="app-settings.js" defer></script>
    <script src="utils.js" defer></script>
    <script src="api.js" defer></script>
    <script src="storage.js" defer></script>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º LZString –ø–µ—Ä–µ–¥ app.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js" async></script>
    <script src="app.js" defer></script>

    <!-- UI Scripts -->
    <script>
        function toggleThemeMenu() {
            const menu = document.getElementById('themeMenu');
            const btn = document.querySelector('.theme-toggle-btn');
            const isActive = menu.classList.toggle('active');

            if (btn) btn.setAttribute('aria-expanded', isActive);

            if (isActive) {
                const firstBtn = menu.querySelector('button');
                if (firstBtn) firstBtn.focus();

                setTimeout(() => document.addEventListener('click', closeMenuOutside), 10);
                document.addEventListener('keydown', handleMenuKeydown);
            } else {
                cleanupMenuListeners();
                if (btn) btn.focus();
            }
        }

        function cleanupMenuListeners() {
             document.removeEventListener('click', closeMenuOutside);
             document.removeEventListener('keydown', handleMenuKeydown);
        }

        function closeMenuOutside(e) {
            if (!e.target.closest('.theme-menu') && !e.target.closest('.theme-toggle-btn')) {
                closeThemeMenu();
            }
        }

        function handleMenuKeydown(e) {
            if (e.key === 'Escape') {
                closeThemeMenu();
            }
        }

        function closeThemeMenu() {
            const menu = document.getElementById('themeMenu');
            const btn = document.querySelector('.theme-toggle-btn');
            if (!menu.classList.contains('active')) return;

            menu.classList.remove('active');
            if (btn) {
                btn.setAttribute('aria-expanded', 'false');
                btn.focus();
            }
            cleanupMenuListeners();
        }

        function setTheme(themeName) {
            if (themeName === 'light') document.body.removeAttribute('data-theme');
            else document.body.setAttribute('data-theme', themeName);
            localStorage.setItem('user-theme', themeName);
            closeThemeMenu();
        }

        function initTheme() {
            const saved = localStorage.getItem('user-theme');
            if (saved) {
                if (saved !== 'light') document.body.setAttribute('data-theme', saved);
                else document.body.removeAttribute('data-theme');
            }
            else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                 document.body.setAttribute('data-theme', 'dark');
            }
        }
        initTheme();
    </script>

    <!-- –û–í–ï–†–õ–ï–ô –ó–ê–ì–†–£–ó–ö–ò (–î–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ –∫–æ–Ω—Ü–µ body) -->
    <div id="loadingOverlay" role="dialog" aria-modal="true" aria-labelledby="loadingText" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; flex-direction: column; align-items: center; justify-content: center; color: white;">
        <div class="loader" style="font-size: 50px; margin-bottom: 20px;">üêí</div>
        <h2 id="loadingText">–î—É–º–∞–µ–º...</h2>
    </div>

</body>
</html>
