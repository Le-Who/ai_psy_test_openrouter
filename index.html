</div>

<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é -->
<script src="config.js"></script>

<script>
    // ===== STATE =====
    const state = {
        apiKey: null,
        blueprint: null,
        questions: [],
        responses: [],
        currentStep: 0
    };

    // ===== API LOGIC =====

    async function callOpenRouter(systemPrompt, userPrompt, schema, modelType = 'generator') {
        const modelName = CONFIG.models[modelType];
        
        if (CONFIG.ui.debugMode) {
            console.log(`üì° API Call [${modelType}]: ${modelName}`);
        }

        try {
            const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${state.apiKey}`,
                    'Content-Type': 'application/json',
                    'HTTP-Referer': window.location.href,
                    'X-Title': 'AI Universal Test'
                },
                body: JSON.stringify({
                    model: modelName,
                    messages: [
                        { role: 'system', content: systemPrompt },
                        { role: 'user', content: userPrompt }
                    ],
                    response_format: schema,
                    temperature: CONFIG.generation.temperature,
                    max_tokens: CONFIG.generation.maxTokens,
                    top_p: CONFIG.generation.topP
                }),
                signal: AbortSignal.timeout(CONFIG.generation.timeoutMs)
            });

            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.error?.message || 'API Error');
            }

            const data = await response.json();
            const content = data.choices[0].message.content;
            
            if (CONFIG.ui.debugMode) {
                console.log(`‚úÖ Response [${modelType}]:`, JSON.parse(content));
            }
            
            return JSON.parse(content);

        } catch (e) {
            console.error(`‚ùå API Error [${modelType}]:`, e);
            throw e;
        }
    }

    // ===== APP FLOW =====

    async function startGeneration(e) {
        e.preventDefault();
        
        const theme = document.getElementById('themeInput').value;
        const audience = document.getElementById('audienceInput').value;
        const count = parseInt(document.getElementById('qCountInput').value);
        state.apiKey = document.getElementById('apiKeyInput').value;

        if (!state.apiKey) return alert("–í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á");

        // –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤–æ–ø—Ä–æ—Å–æ–≤
        if (count < CONFIG.limits.minQuestions || count > CONFIG.limits.maxQuestions) {
            return alert(`–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç ${CONFIG.limits.minQuestions} –¥–æ ${CONFIG.limits.maxQuestions}`);
        }

        switchView('loading');
        document.getElementById('errorBox').style.display = 'none';

        try {
            // Step 1: Blueprint
            updateLoading("–ü—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã...", "AI –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø —Ç–µ—Å—Ç–∞ –∏ –≤–æ–∑–º–æ–∂–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã");
            
            const blueprintData = await callOpenRouter(
                PROMPTS.architect,
                `–¢–µ–º–∞: "${theme}". –ê—É–¥–∏—Ç–æ—Ä–∏—è: "${audience}".`,
                SCHEMAS.blueprint,
                'architect'
            );
            state.blueprint = blueprintData;

            // Step 2: Content
            const typeName = state.blueprint.testType === 'categorical' ? '–ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π/—Ç–∏–ø–æ–≤' : '—à–∫–∞–ª';
            updateLoading("–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤...", `–°–æ–∑–¥–∞–µ–º ${count} –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è ${state.blueprint.outcomes.length} ${typeName}`);

            const contentData = await callOpenRouter(
                PROMPTS.generator,
                `–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π ${count} –≤–æ–ø—Ä–æ—Å–æ–≤.
                –¢–∏–ø —Ç–µ—Å—Ç–∞: ${state.blueprint.testType}.
                –†–µ–∑—É–ª—å—Ç–∞—Ç—ã (Outcomes): ${JSON.stringify(state.blueprint.outcomes)}.
                –ê—É–¥–∏—Ç–æ—Ä–∏—è: ${audience}.`,
                SCHEMAS.questions,
                'generator'
            );
            state.questions = contentData.questions;

            // Start Test
            state.currentStep = 0;
            state.responses = [];
            renderQuestion();
            switchView('test');

        } catch (err) {
            showError("–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: " + err.message);
            switchView('setup');
        }
    }

    // ===== TEST ENGINE =====

    function renderQuestion() {
        const q = state.questions[state.currentStep];
        document.getElementById('qCurrent').innerText = state.currentStep + 1;
        document.getElementById('qTotal').innerText = state.questions.length;
        document.getElementById('questionText').innerText = q.text;
        
        const pct = ((state.currentStep) / state.questions.length) * 100;
        document.getElementById('progressBar').style.width = `${pct}%`;

        document.querySelectorAll('.likert-opt').forEach(el => el.classList.remove('selected'));
    }

    function answer(val) {
        const opts = document.querySelectorAll('.likert-opt');
        opts[val-1].classList.add('selected');

        state.responses[state.currentStep] = val;

        setTimeout(() => {
            state.currentStep++;
            if (state.currentStep < state.questions.length) {
                renderQuestion();
            } else {
                finishTest();
            }
        }, CONFIG.ui.answerDelayMs);
    }

    function finishTest() {
        switchView('loading');
        updateLoading("–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤...", "–ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –±–∞–ª–ª—ã –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ—Ñ–∏–ª—å");
        
        setTimeout(() => {
            displayResults();
            switchView('results');
        }, CONFIG.ui.resultsAnimationDelay);
    }

    function displayResults() {
        const scores = {};
        
        state.blueprint.outcomes.forEach(out => scores[out.id] = 0);

        state.questions.forEach((q, idx) => {
            const userAns = state.responses[idx];
            const multiplier = userAns - 3;

            q.mapping.forEach(map => {
                if (scores[map.outcomeId] !== undefined) {
                    scores[map.outcomeId] += map.weight * multiplier;
                }
            });
        });

        const container = document.getElementById('resultsContent');
        let html = '';

        if (state.blueprint.testType === 'categorical') {
            let winnerId = null;
            let maxScore = -Infinity;
            
            for (const [id, score] of Object.entries(scores)) {
                if (score > maxScore) {
                    maxScore = score;
                    winnerId = id;
                }
            }
            
            const winner = state.blueprint.outcomes.find(o => o.id === winnerId);
            const others = state.blueprint.outcomes
                .filter(o => o.id !== winnerId)
                .sort((a, b) => scores[b.id] - scores[a.id]);

            html = `
                <div class="result-header">
                    <div style="font-size: 14px; color: #64748b; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px;">–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç</div>
                    <h2>${winner.name}</h2>
                    <p style="font-size: 18px; line-height: 1.6;">${winner.description}</p>
                </div>
                <hr style="border: 0; border-top: 1px solid #e2e8f0; margin: 30px 0;">
                <h4 style="margin-bottom: 15px; color: #64748b;">–ë–ª–∏–∑–æ—Å—Ç—å –∫ –¥—Ä—É–≥–∏–º –≤–∞—Ä–∏–∞–Ω—Ç–∞–º:</h4>
                ${others.map(o => `
                    <div class="result-item">
                        <span style="width: 120px; font-weight: 500;">${o.name}</span>
                        <div class="result-bar-container">
                            <div class="result-bar-val" style="width: ${calculatePercent(scores[o.id], maxScore)}%"></div>
                        </div>
                    </div>
                `).join('')}
            `;

        } else {
            html = `<div class="result-header"><h2>–í–∞—à –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ü–æ—Ä—Ç—Ä–µ—Ç</h2></div>`;
            
            state.blueprint.outcomes.forEach(out => {
                const raw = scores[out.id];
                const percent = Math.min(100, Math.max(10, 50 + (raw * 5)));
                
                html += `
                    <div style="margin-bottom: 24px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                            <strong>${out.name}</strong>
                            <span>${raw > 0 ? '–í—ã—Å–æ–∫–∏–π' : raw < 0 ? '–ù–∏–∑–∫–∏–π' : '–°—Ä–µ–¥–Ω–∏–π'}</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${percent}%"></div>
                        </div>
                        <p style="font-size: 13px; color: #64748b;">${out.description}</p>
                    </div>
                `;
            });
        }

        container.innerHTML = html;
    }

    function calculatePercent(val, max) {
        if (max === 0) return 0;
        const ratio = (val / max);
        return Math.max(0, ratio * 100);
    }

    // ===== UI UTILS =====

    function switchView(id) {
        document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
        document.getElementById(id + 'View').classList.add('active');
    }

    function updateLoading(title, subtitle) {
        document.getElementById('loadingTitle').innerText = title;
        document.getElementById('loadingSubtitle').innerText = subtitle;
    }

    function showError(msg) {
        const box = document.getElementById('errorBox');
        box.innerText = msg;
        box.style.display = 'block';
    }

</script>

</body>
</html>
