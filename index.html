<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ï–≤–¥–æ–∫–∏—è –¢–µ—Å—Ç–∏–∫–æ–≤–∞</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text: #1e293b;
            --text-light: #64748b;
            --border: #e2e8f0;
            --radius: 12px;
            --danger: #ef4444;
        }

        * { box-sizing: border-box; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; }

        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        
        /* UI Components */
        .card { background: var(--surface); padding: 30px; border-radius: var(--radius); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 20px; border: 1px solid var(--border); }
        
        .btn { background: var(--primary); color: white; border: none; padding: 12px 20px; width: 100%; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: 15px;}
        .btn:hover { background: var(--primary-hover); transform: translateY(-1px); }
        .btn:disabled { opacity: 0.7; cursor: not-allowed; transform: none; }
        .btn-secondary { background: #e2e8f0; color: var(--text); }
        .btn-secondary:hover { background: #cbd5e1; }
        .btn-text { background: none; color: var(--primary); padding: 0; width: auto; font-weight: 600; }
        .btn-text:hover { text-decoration: underline; transform: none; background: none;}
        
        input, select { width: 100%; padding: 12px; margin-top: 6px; border: 1px solid var(--border); border-radius: 8px; font-size: 15px; transition: border 0.2s; }
        input:focus, select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
        label { font-weight: 600; font-size: 14px; display: block; margin-top: 18px; color: var(--text); }

        /* Views */
        .view { display: none; animation: fadeIn 0.4s ease-out; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Test UI */
        .likert-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin: 30px 0; }
        .likert-opt { border: 2px solid var(--border); padding: 15px 5px; text-align: center; border-radius: 8px; cursor: pointer; font-weight: 700; color: var(--text-light); transition: all 0.2s; }
        .likert-opt:hover { border-color: var(--primary); background: #eff6ff; color: var(--primary); }
        .likert-opt.selected { background: var(--primary); color: white; border-color: var(--primary); transform: scale(1.05); }

        .progress { height: 8px; background: #e2e8f0; border-radius: 99px; overflow: hidden; margin-bottom: 25px; }
        .bar { height: 100%; background: var(--primary); width: 0%; transition: width 0.4s ease; }

        /* Results */
        .res-item { margin-bottom: 18px; }
        .res-bar-bg { background: #f1f5f9; height: 10px; border-radius: 5px; overflow: hidden; margin-top: 6px; }
        .res-bar-fill { background: var(--primary); height: 100%; border-radius: 5px; }

        /* Loader */
        .loader { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s infinite; margin: 0 auto 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .header { text-align: center; margin-bottom: 30px; padding-top: 20px; }
        .header h1 { margin: 0; font-size: 24px; color: var(--text); }
        .header p { margin: 5px 0 0; color: var(--text-light); font-size: 14px; }
        .badge { background: #dbeafe; color: #1e40af; padding: 2px 8px; border-radius: 12px; font-size: 11px; vertical-align: middle; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>üîÆ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –¢–µ—Å—Ç–æ–≤ –∏–º–µ–Ω–∏ –î—É–Ω–∏ –ü–∞—Ö—É—á–µ–π</h1>
        <p>–†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —Ö–ª–æ–ø—å—è—Ö —Å –º–æ–ª–æ–∫–æ–º</p>
    </div>

    <div id="errorBox" style="background:#fef2f2; color:#991b1b; padding:15px; border-radius:8px; display:none; margin-bottom:20px; border:1px solid #fecaca;"></div>

    <!-- 1. VIEW: SETUP -->
    <div id="setupView" class="view active">
        <!-- –ö–Ω–æ–ø–∫–∞ –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
        <div style="display: flex; justify-content: flex-end; margin-bottom: 10px;">
            <button onclick="app.openLibrary()" class="btn-text">üìÇ –ú–æ—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞</button>
        </div>

        <div class="card">
            <h2 style="margin-top: 0; font-size: 20px;">–ù–æ–≤—ã–π —Ç–µ—Å—Ç</h2>
            <form id="setupForm">
                <label>–¢–µ–º–∞ —Ç–µ—Å—Ç–∞</label>
                <input type="text" id="themeInput" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö—Ç–æ —Ç—ã –∏–∑ –í—Å–µ–ª–µ–Ω–Ω–æ–π –ì–∞—Ä—Ä–∏ –ü–æ—Ç—Ç–µ—Ä–∞?" required>
                
                <label>–î–ª—è –∫–æ–≥–æ (–ê—É–¥–∏—Ç–æ—Ä–∏—è)</label>
                <input type="text" id="audienceInput" value="–û–±—â–∞—è" placeholder="–ü–æ–¥—Ä–æ—Å—Ç–∫–∏, IT-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—ã...">
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <label>–í–æ–ø—Ä–æ—Å–æ–≤</label>
                        <select id="qCountInput">
                            <option value="5">5 (–ó–∞—á–µ–º?)</option>
                            <option value="10">10 (–ë—ã—Å—Ç—Ä—ã–π)</option>
                            <option value="15">15 (–û–±—ã—á–Ω—ã–π)</option>
                            <option value="25">25 (–ü–æ–¥—Ä–æ–±–Ω—ã–π)</option>
                            <option value="69">69 (–í–∏—Ä—Ç?)</option>
                        </select>
                    </div>
                    <div>
                        <label>–ü—Ä–æ–≤–∞–π–¥–µ—Ä</label>
                        <select disabled style="background: #f1f5f9;">
                            <option>–ê–≤—Ç–æ-–≤—ã–±–æ—Ä –ø–æ –∫–ª—é—á—É</option>
                        </select>
                    </div>
                </div>

                <label>API –ö–ª—é—á <span style="font-weight:normal; color:#64748b; font-size:12px;">(OpenRouter –∏–ª–∏ Gemini)</span></label>
                <input type="password" id="apiKeyInput" placeholder="sk-or-... –∏–ª–∏ AIza..." required>
                
                <button type="submit" class="btn" style="margin-top: 25px;">üöÄ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¢–µ—Å—Ç</button>
            </form>
        </div>
    </div>

    <!-- 2. VIEW: LIBRARY -->
    <div id="libraryView" class="view">
        <div id="libraryContent">
            <!-- –°—é–¥–∞ JS –≤—Å—Ç–∞–≤–∏—Ç —Å–ø–∏—Å–æ–∫ -->
        </div>
    </div>

    <!-- 3. VIEW: LOADING -->
    <div id="loadingView" class="view" style="text-align: center; padding-top: 50px;">
        <div class="loader"></div>
        <h3 id="loadTitle">–ó–∞–ø—É—Å–∫...</h3>
        <p id="loadDesc" style="color: var(--text-light);">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–µ–ª–µ–π</p>
    </div>

    <!-- 4. VIEW: TEST -->
    <div id="testView" class="view">
        <div class="progress"><div id="progressBar" class="bar"></div></div>
        <div class="card">
            <div style="display:flex; justify-content:space-between; margin-bottom: 15px; color: var(--text-light); font-size: 13px; font-weight: 600;">
                <span>–í–û–ü–†–û–° <span id="qNum">1</span></span>
            </div>
            <h3 id="qText" style="font-size: 22px; margin-bottom: 30px; line-height: 1.4;">...</h3>
            
            <div class="likert-grid">
                <div class="likert-opt" onclick="app.answer(1)">1</div>
                <div class="likert-opt" onclick="app.answer(2)">2</div>
                <div class="likert-opt" onclick="app.answer(3)">3</div>
                <div class="likert-opt" onclick="app.answer(4)">4</div>
                <div class="likert-opt" onclick="app.answer(5)">5</div>
            </div>
            <div style="display:flex; justify-content:space-between; font-size:13px; color:var(--text-light); padding:0 5px; font-weight:500;">
                <span>‚ùå –ù–µ—Ç / –ù–∏–∫–æ–≥–¥–∞</span>
                <span>‚úÖ –î–∞ / –í—Å–µ–≥–¥–∞</span>
            </div>
        </div>
    </div>

    <!-- 5. VIEW: RESULTS -->
    <div id="resultsView" class="view">
        <div class="card" id="resContent">
            <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <button class="btn" onclick="location.reload()">‚Ü∫ –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π</button>
            <button class="btn btn-secondary" id="saveTestBtn" onclick="app.saveCurrentTest()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫—É</button>
        </div>
    </div>
</div>

<!-- –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –°–ö–†–ò–ü–¢–û–í -->
<!-- 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (–ü—Ä–æ–º–ø—Ç—ã, –°—Ö–µ–º—ã, –ö–æ–Ω—Ñ–∏–≥ –º–æ–¥–µ–ª–µ–π) -->
<script src="app-settings.js"></script>
<!-- 2. –•—Ä–∞–Ω–∏–ª–∏—â–µ (–õ–æ–≥–∏–∫–∞ LocalStorage) -->
<script src="storage.js"></script> 

<!-- 3. –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ -->
<script>
// --- API –ö–õ–ò–ï–ù–¢ (–û–ø—Ä–µ–¥–µ–ª–µ–Ω –î–û app, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –æ—à–∏–±–æ–∫) ---
const api = {
    detectProvider(key) {
        // –ü—Ä–æ—Å—Ç–æ–π –¥–µ—Ç–µ–∫—Ç–æ—Ä: Gemini –∫–ª—é—á–∏ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å AIza
        return key.startsWith('AIza') ? 'gemini' : 'openrouter';
    },

    // –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–∞—Ä—Å–µ—Ä JSON (–¥–ª—è Xiaomi –∏ –¥—Ä—É–≥–∏—Ö –º–æ–¥–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –≤–µ—Ä–Ω—É—Ç—å Markdown)
    safeParseJSON(text) {
        try {
            return JSON.parse(text);
        } catch (e) {
            console.warn("Direct JSON parse failed, attempting regex extraction...");
            // 1. –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ JSON –æ–±—ä–µ–∫—Ç –∏–ª–∏ –º–∞—Å—Å–∏–≤
            const match = text.match(/(\{[\s\S]*\}|\[[\s\S]*\])/);
            if (match) {
                try { return JSON.parse(match[0]); } catch (e2) {}
            }
            // 2. –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ Markdown –±–ª–æ–∫ ```json ... ```
            const mdMatch = text.match(/```(?:json)?\s*([\s\S]*?)\s*```/);
            if (mdMatch) {
                try { return JSON.parse(mdMatch[1]); } catch (e3) {}
            }
            throw new Error("API –≤–µ—Ä–Ω—É–ª –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö (–Ω–µ JSON).");
        }
    },

    // –ì–ª–∞–≤–Ω—ã–π –º–µ—Ç–æ–¥ –≤—ã–∑–æ–≤–∞
    async call(systemPrompt, userPrompt, schema, modelType, apiKey) {
        const provider = this.detectProvider(apiKey);
        console.log(`üì° Sending request via: ${provider.toUpperCase()} (${modelType})`);

        // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å—Ö–µ–º—ã (—á–∏—Å—Ç–∫–∞ –æ—Ç additionalProperties –¥–ª—è Gemini)
        const cleanSchema = this.prepareSchema(schema);

        if (provider === 'gemini') {
            return this.callGemini(systemPrompt, userPrompt, cleanSchema, modelType, apiKey);
        } else {
            return this.callOpenRouter(systemPrompt, userPrompt, cleanSchema, modelType, apiKey);
        }
    },

    prepareSchema(schema) {
        // –ö–ª–æ–Ω–∏—Ä—É–µ–º –∏ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º json_schema.schema –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        let s = JSON.parse(JSON.stringify(schema));
        if (s.json_schema && s.json_schema.schema) s = s.json_schema.schema;

        // –†–µ–∫—É—Ä—Å–∏–≤–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
        const clean = (obj) => {
            if (!obj || typeof obj !== 'object') return;
            // Gemini –ø–∞–¥–∞–µ—Ç –µ—Å–ª–∏ –≤–∏–¥–∏—Ç additionalProperties
            if ('additionalProperties' in obj) delete obj.additionalProperties;
            if (obj.properties) Object.values(obj.properties).forEach(clean);
            if (obj.items) clean(obj.items);
        };
        clean(s);
        return s;
    },

    async callOpenRouter(sys, user, schema, type, key) {
        const model = CONFIG.providers.openrouter.models[type];
        
        try {
            const res = await fetch(CONFIG.providers.openrouter.endpoint, {
                method: 'POST',
                headers: CONFIG.providers.openrouter.headers(key),
                body: JSON.stringify({
                    model: model,
                    messages: [{role: 'system', content: sys}, {role: 'user', content: user}],
                    // –î–ª—è Xiaomi Free –ª—É—á—à–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∏–ª–∏ –≤–æ–æ–±—â–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å,
                    // –µ—Å–ª–∏ –æ–Ω–∞ –ø–∞–¥–∞–µ—Ç. –ó–¥–µ—Å—å –æ—Å—Ç–∞–≤–ª—è–µ–º json_object –∫–∞–∫ –∫–æ–º–ø—Ä–æ–º–∏—Å—Å.
                    response_format: { type: "json_object" }, 
                    temperature: 0.7
                })
            });
            
            if (!res.ok) {
                const err = await res.json();
                throw new Error(err.error?.message || 'OpenRouter API Error');
            }
            
            const data = await res.json();
            return this.safeParseJSON(data.choices[0].message.content);

        } catch (e) {
            console.error("OpenRouter Error:", e);
            throw e;
        }
    },

    async callGemini(sys, user, schema, type, key) {
        const model = CONFIG.providers.gemini.models[type];
        const url = `${CONFIG.providers.gemini.endpoint}${model}:generateContent?key=${key}`;

        // Gemini –ª—É—á—à–µ —Å–ª—É—à–∞–µ—Ç—Å—è, –µ—Å–ª–∏ —Å—Ö–µ–º—É –ø–æ–∫–∞–∑–∞—Ç—å –µ—â–µ –∏ –≤ –ø—Ä–æ–º–ø—Ç–µ —Ç–µ–∫—Å—Ç–æ–º
        const prompt = `${sys}\n\n–û–¢–í–ï–¢–¨ –°–¢–†–û–ì–û –í –§–û–†–ú–ê–¢–ï JSON:\n${JSON.stringify(schema)}\n\n–ó–ê–î–ê–ß–ê –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø: ${user}`;

        const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    temperature: 0.7,
                    response_mime_type: "application/json"
                    // response_schema –º—ã –Ω–µ —à–ª–µ–º –∑–¥–µ—Å—å, –ø–æ–ª–∞–≥–∞—è—Å—å –Ω–∞ –ø—Ä–æ–º–ø—Ç, 
                    // —Ç–∞–∫ –∫–∞–∫ –≤ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–º Flash –∏–Ω–æ–≥–¥–∞ –±—ã–≤–∞—é—Ç –≥–ª—é–∫–∏ —Å–æ —Å—Ö–µ–º–æ–π
                }
            })
        });

        if (!res.ok) {
            const err = await res.json();
            throw new Error(err.error?.message || 'Gemini API Error');
        }

        const data = await res.json();
        const text = data.candidates[0].content.parts[0].text;
        return this.safeParseJSON(text);
    }
};

// --- APP LOGIC (–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ) ---
const app = {
    // –ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    state: { 
        step: 0, 
        answers: [], 
        questions: [], 
        blueprint: null, // –ë—ã–ª–æ {}, —Å—Ç–∞–ª–æ null –¥–ª—è —á–µ—Ç–∫–æ—Å—Ç–∏
        apiKey: '' 
    },

    async start(e) {
        e.preventDefault();
        
        // 1. –°—á–∏—Ç—ã–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        const keyInput = document.getElementById('apiKeyInput');
        this.state.apiKey = keyInput ? keyInput.value.trim() : '';
        
        const theme = document.getElementById('themeInput').value;
        const count = document.getElementById('qCountInput').value;

        if(!this.state.apiKey) return alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á!");

        // 2. –û–ß–ò–°–¢–ö–ê –°–û–°–¢–û–Ø–ù–ò–Ø (–í–∞–∂–Ω–æ –ø—Ä–∏ —Å–º–µ–Ω–µ –∫–ª—é—á–µ–π/—Ç–µ—Å—Ç–æ–≤)
        this.state.blueprint = null;
        this.state.questions = [];
        this.state.answers = [];
        this.state.step = 0;

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–ª—é—á –≤ —Å–µ—Å—Å–∏–∏
        sessionStorage.setItem('temp_api_key', this.state.apiKey);

        this.setLoading(true, "üß† –ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä –ø—Ä–æ–µ–∫—Ç–∏—Ä—É–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É...");
        document.getElementById('errorBox').style.display = 'none';

        try {
            // –≠–¢–ê–ü 1: Blueprint (—Å –∞–≤—Ç–æ-–ø–æ–≤—Ç–æ—Ä–æ–º –¥–ª—è —Å–ª–∞–±—ã—Ö –º–æ–¥–µ–ª–µ–π)
            let attempts = 0;
            let blueprint = null;
            
            while(attempts < 3 && !blueprint) {
                try {
                    attempts++;
                    console.log(`Attempt ${attempts} to generate blueprint...`);
                    
                    const res = await api.call(
                        PROMPTS.architect,
                        `–¢–µ–º–∞: "${theme}". –ü—Ä–∏–¥—É–º–∞–π —Å—Ç—Ä—É–∫—Ç—É—Ä—É. –û–¢–í–ï–¢–¨ –¢–û–õ–¨–ö–û –í JSON.`, // –£—Å–∏–ª–∏–ª–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ
                        SCHEMAS.blueprint,
                        'architect',
                        this.state.apiKey
                    );
                    
                    if (res && res.outcomes) {
                        blueprint = res;
                    }
                } catch (e) {
                    console.warn(`Attempt ${attempts} failed:`, e);
                    if (attempts === 3) throw e; // –ï—Å–ª–∏ 3 —Ä–∞–∑–∞ –Ω–µ –≤—ã—à–ª–æ, —Å–¥–∞–µ–º—Å—è
                }
            }

            if (!blueprint || !blueprint.outcomes) {
                throw new Error("–ú–æ–¥–µ–ª—å –Ω–µ —Å–º–æ–≥–ª–∞ —Å–æ–∑–¥–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–µ—Å—Ç–∞ –∑–∞ 3 –ø–æ–ø—ã—Ç–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥—É—é —Ç–µ–º—É.");
            }
            this.state.blueprint = blueprint;

            // –≠–¢–ê–ü 2: –í–æ–ø—Ä–æ—Å—ã
            this.setLoading(true, "‚úçÔ∏è –ê–≤—Ç–æ—Ä –ø–∏—à–µ—Ç –≤–æ–ø—Ä–æ—Å—ã...");
            
            const genPrompt = `–¢–µ–º–∞: ${theme}. –¢–∏–ø —Ç–µ—Å—Ç–∞: ${blueprint.testType}.
            –í–æ–∑–º–æ–∂–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã: ${JSON.stringify(blueprint.outcomes)}.
            –ù—É–∂–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å ${count} –≤–æ–ø—Ä–æ—Å–æ–≤.
            
            –í–ê–ñ–ù–û –ü–†–û –í–ï–°–ê:
            –ò—Å–ø–æ–ª—å–∑—É–π "–ú—è–≥–∫–∏–µ –≤–µ—Å–∞"! –û–¥–∏–Ω –≤–æ–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω –≤–ª–∏—è—Ç—å –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.
            –ù–µ –¥–µ–ª–∞–π –±–∏–Ω–∞—Ä–Ω—ã—Ö (0/1) –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π.`;

            const content = await api.call(
                PROMPTS.generator,
                genPrompt,
                SCHEMAS.questions,
                'generator',
                this.state.apiKey
            );
            
            if (!content || !content.questions) {
                throw new Error("–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –Ω–µ –≤–µ—Ä–Ω—É–ª –≤–æ–ø—Ä–æ—Å—ã.");
            }
            this.state.questions = content.questions;
            
            // –ó–ê–ü–£–°–ö
            this.renderQ();
            this.setView('test');

        } catch (err) {
            console.error(err);
            document.getElementById('errorBox').style.display = 'block';
            document.getElementById('errorBox').innerHTML = `<strong>–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:</strong><br>${err.message}`;
            this.setView('setup');
        }
    },

    renderQ() {
        const q = this.state.questions[this.state.step];
        document.getElementById('qNum').innerText = `${this.state.step + 1} / ${this.state.questions.length}`;
        document.getElementById('qText').innerText = q.text;
        
        const pct = (this.state.step / this.state.questions.length) * 100;
        document.getElementById('progressBar').style.width = pct + '%';
        
        document.querySelectorAll('.likert-opt').forEach(d => d.classList.remove('selected'));
    },

    answer(val) {
        this.state.answers[this.state.step] = val;
        document.querySelectorAll('.likert-opt')[val-1].classList.add('selected');
        
        setTimeout(() => {
            this.state.step++;
            if(this.state.step < this.state.questions.length) {
                this.renderQ();
            } else {
                this.finish();
            }
        }, 250);
    },

    finish() {
        this.setLoading(true, "üìä –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–∞—à–∏ –æ—Ç–≤–µ—Ç—ã...");
        this.setView('loading');
        
        // –î–∞–µ–º UI –≤—Ä–µ–º—è –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ —Ç—è–∂–µ–ª—ã–º–∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è–º–∏
        setTimeout(() => {
            try {
                this.calc();
                this.setView('results');
            } catch (e) {
                console.error(e);
                alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: " + e.message);
                this.setView('setup'); // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ –º–µ–Ω—é –ø—Ä–∏ –æ—à–∏–±–∫–µ
            }
        }, 600);
    },

    calc() {
        // --- –ó–ê–©–ò–¢–ê: –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ —á—Ç–µ–Ω–∏–µ–º ---
        if (!this.state.blueprint || !this.state.blueprint.outcomes) {
            console.error("Critical: Blueprint state is broken", this.state.blueprint);
            throw new Error("–î–∞–Ω–Ω—ã–µ –æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ —Ç–µ—Å—Ç–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.");
        }
        
        const scores = {};
        // –í–æ—Ç –∑–¥–µ—Å—å –±—ã–ª–∞ –æ—à–∏–±–∫–∞ .forEach undefined
        this.state.blueprint.outcomes.forEach(o => scores[o.id] = 0);

        this.state.questions.forEach((q, idx) => {
            const ans = this.state.answers[idx];
            // –ó–∞—â–∏—Ç–∞: –µ—Å–ª–∏ –æ—Ç–≤–µ—Ç–∞ –Ω–µ—Ç, —Å—á–∏—Ç–∞–µ–º –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–º (3)
            const userVal = (ans !== undefined ? ans : 3) - 3; 
            
            if (q.mapping && Array.isArray(q.mapping)) {
                q.mapping.forEach(m => {
                    if(scores[m.outcomeId] !== undefined) {
                        scores[m.outcomeId] += (m.weight * userVal);
                    }
                });
            }
        });

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞
        const container = document.getElementById('resContent');
        let html = '';
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Ç–µ—Å—Ç–∞ (–µ—Å–ª–∏ –ø–æ–ª–µ –ø–æ—Ç–µ—Ä—è–ª–æ—Å—å, —Å—á–∏—Ç–∞–µ–º categorical –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
        const isCategorical = (this.state.blueprint.testType !== 'dimensional');
        
        if(isCategorical) {
            const sorted = this.state.blueprint.outcomes.sort((a,b) => scores[b.id] - scores[a.id]);
            const win = sorted[0];
            
            let maxScore = Math.max(...Object.values(scores));
            if (maxScore <= 0) maxScore = 1; 

            html = `<div style="text-align:center; padding-bottom: 20px;">
                <div style="font-size:12px; text-transform:uppercase; letter-spacing:1px; color:#64748b; margin-bottom:10px;">–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç</div>
                <h2 style="font-size:32px; margin:0 0 10px; color:var(--primary);">${win.name}</h2>
                <p style="font-size:18px; line-height:1.6;">${win.description}</p>
            </div>
            <div style="background:#f1f5f9; padding:20px; border-radius:12px;">
                <h4 style="margin:0 0 15px; color:#475569;">–î—Ä—É–≥–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã:</h4>`;
            
            sorted.slice(1).forEach(o => {
                let pct = 0;
                if (scores[o.id] > 0) pct = (scores[o.id] / maxScore) * 100;
                
                html += `<div class="res-item">
                    <div style="display:flex; justify-content:space-between; font-size:14px; margin-bottom:5px;">
                        <span>${o.name}</span>
                        <span style="color:#94a3b8; font-size:12px;">${Math.round(pct)}%</span>
                    </div>
                    <div class="res-bar-bg"><div class="res-bar-fill" style="width:${pct}%"></div></div>
                </div>`;
            });
            html += `</div>`;
        } else {
            // Dimensional
            html = `<h3 style="text-align:center; margin-bottom:25px;">–í–∞—à –ü—Ä–æ—Ñ–∏–ª—å</h3>`;
            this.state.blueprint.outcomes.forEach(o => {
                const s = scores[o.id];
                const pct = Math.min(100, Math.max(0, 50 + (s * 5)));
                
                let levelText = "–°—Ä–µ–¥–Ω–∏–π";
                if(pct > 70) levelText = "–í—ã—Å–æ–∫–∏–π";
                if(pct < 30) levelText = "–ù–∏–∑–∫–∏–π";

                html += `<div class="res-item">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <strong>${o.name}</strong>
                        <span class="badge">${levelText}</span>
                    </div>
                    <div class="res-bar-bg"><div class="res-bar-fill" style="width:${pct}%"></div></div>
                    <small style="color:#64748b; display:block; margin-top:5px;">${o.description}</small>
                </div>`;
            });
        }
        container.innerHTML = html;

        // –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        const saveBtn = document.getElementById('saveTestBtn');
        if (saveBtn) {
            saveBtn.innerHTML = "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫—É";
            saveBtn.className = "btn btn-secondary";
            saveBtn.disabled = false;
        }
    },

    setView(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(id+'View').classList.add('active');
    },
    
    setLoading(active, msg) {
        if(active) {
            this.setView('loading');
            document.getElementById('loadTitle').innerText = msg;
        }
    },

    // === –ë–ò–ë–õ–ò–û–¢–ï–ö–ê –ò –°–û–•–†–ê–ù–ï–ù–ò–ï ===

    openLibrary() {
        if (typeof Storage === 'undefined') {
            return alert("–û—à–∏–±–∫–∞: —Ñ–∞–π–ª storage.js –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω!");
        }
        const html = Storage.renderLibraryHTML();
        document.getElementById('libraryContent').innerHTML = html;
        this.setView('library');
    },

    saveCurrentTest() {
        const themeName = document.getElementById('themeInput').value || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è";
        const success = Storage.save(this.state.blueprint, this.state.questions, themeName);
        
        const btn = document.getElementById('saveTestBtn');
        if (success) {
            btn.innerHTML = "‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!";
            btn.className = "btn"; // –î–µ–ª–∞–µ–º —Å–∏–Ω–µ–π
            btn.disabled = true;
        } else {
            alert("–≠—Ç–æ—Ç —Ç–µ—Å—Ç —É–∂–µ –µ—Å—Ç—å –≤ –≤–∞—à–µ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–µ.");
        }
    },

    loadSavedTest(id) {
        const test = Storage.getById(id);
        if (!test) return alert("–¢–µ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω!");

        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        this.state.blueprint = test.blueprint;
        this.state.questions = test.questions;
        
        // –°–±—Ä–æ—Å –∏ –∑–∞–ø—É—Å–∫
        this.state.step = 0;
        this.state.answers = [];
        this.renderQ();
        this.setView('test');
    },

    deleteTest(id) {
        if(confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–µ—Å—Ç?")) {
            Storage.delete(id);
            this.openLibrary(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
        }
    }
};

// –ó–∞–ø—É—Å–∫ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ —Ñ–æ—Ä–º—ã
document.getElementById('setupForm').addEventListener('submit', (e) => app.start(e));
</script>

</body>
</html>
