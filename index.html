<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ï–≤–¥–æ–∫–∏—è –¢–µ—Å—Ç–∏–∫–æ–≤–∞</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="container">
    
    <!-- –ù–ê–ß–ê–õ–û –ë–õ–û–ö–ê –•–ï–î–ï–†–ê –° –¢–ï–ú–ê–ú–ò -->
    <div class="header-row">
        <div class="header-content">
            <h1>üîÆ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –¢–µ—Å—Ç–æ–≤ –∏–º. –î—É–Ω–∏ –ü–∞—Ö—É—á–µ–π üíÖ</h1>
            <p>–†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —Ö–ª–æ–ø—å—è—Ö —Å –º–æ–ª–æ–∫–æ–º ü•£</p>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∞-–ø–∏–ø–µ—Ç–∫–∞ -->
        <button class="theme-toggle-btn" onclick="toggleThemeMenu()" title="–í—ã–±—Ä–∞—Ç—å —Ç–µ–º—É –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è">
            üé®
        </button>

        <!-- –ú–µ–Ω—é –≤—ã–±–æ—Ä–∞ (–≤—ã–ø–∞–¥–∞–µ—Ç –ø—Ä–∏ –∫–ª–∏–∫–µ) -->
        <div class="theme-menu" id="themeMenu">
            <div class="theme-opt" onclick="setTheme('light')">
                <div class="theme-circle" style="background: #fff; border: 1px solid #ddd;"></div>
                –°–≤–µ—Ç–ª–∞—è
            </div>
            <div class="theme-opt" onclick="setTheme('dark')">
                <div class="theme-circle" style="background: #1e293b;"></div>
                –¢–µ–º–Ω–∞—è
            </div>
            <div class="theme-opt" onclick="setTheme('gray')">
                <div class="theme-circle" style="background: #e5e5e5; border: 1px solid #999;"></div>
                –ë—É–º–∞–≥–∞
            </div>
        </div>
    </div>
    <!-- –ö–û–ù–ï–¶ –ë–õ–û–ö–ê –•–ï–î–ï–†–ê -->

    <div id="errorBox" style="background:#fef2f2; color:#991b1b; padding:15px; border-radius:12px; display:none; margin-bottom:20px; border:1px solid #fecaca;"></div>

    <!-- 1. VIEW: SETUP -->
    <div id="setupView" class="view active">
        <!-- –ö–Ω–æ–ø–∫–∞ –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
        <div style="display: flex; justify-content: flex-end; margin-bottom: 10px;">
            <button onclick="app.openLibrary()" class="btn-text">üìÇ –ú–æ—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞</button>
        </div>

        <div class="card">
            <h2 style="margin-top: 0; font-size: 20px;">–ù–æ–≤—ã–π —Ç–µ—Å—Ç</h2>
            <form id="setupForm">
                <label>–¢–µ–º–∞ —Ç–µ—Å—Ç–∞</label>
                <input type="text" id="themeInput" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö—Ç–æ —Ç—ã –∏–∑ –í—Å–µ–ª–µ–Ω–Ω–æ–π –ì–∞—Ä—Ä–∏ –ü–æ—Ç—Ç–µ—Ä–∞?" required>
                
                <label>–î–ª—è –∫–æ–≥–æ (–ê—É–¥–∏—Ç–æ—Ä–∏—è)</label>
                <input type="text" id="audienceInput" value="–û–±—â–∞—è" placeholder="–ü–æ–¥—Ä–æ—Å—Ç–∫–∏, IT-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—ã...">
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <label>–í–æ–ø—Ä–æ—Å–æ–≤</label>
                        <select id="qCountInput">
                            <option value="5">5 (–ó–∞—á–µ–º?)</option>
                            <option value="10" selected>10 (–ë—ã—Å—Ç—Ä—ã–π)</option>
                            <option value="15">15 (–û–±—ã—á–Ω—ã–π)</option>
                            <option value="25">25 (–ü–æ–¥—Ä–æ–±–Ω—ã–π)</option>
                            <option value="69">69 (–¢—É–º–∞—á?)</option>
                        </select>
                    </div>
                    <div>
                        <label>–ü—Ä–æ–≤–∞–π–¥–µ—Ä</label>
                        <select disabled style="background: #f1f5f9;">
                            <option>–ê–≤—Ç–æ-–≤—ã–±–æ—Ä –ø–æ –∫–ª—é—á—É</option>
                        </select>
                    </div>
                </div>

                <label>API –ö–ª—é—á <span style="font-weight:normal; color:#64748b; font-size:12px;">(OpenRouter –∏–ª–∏ Gemini)</span></label>
                <input type="password" id="apiKeyInput" placeholder="sk-or-... –∏–ª–∏ AIza..." required>
                
                <button type="submit" class="btn" style="margin-top: 25px;">üöÄ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¢–µ—Å—Ç</button>
            </form>
        </div>
    </div>

    <!-- 2. VIEW: LIBRARY -->
    <div id="libraryView" class="view">
        <div id="libraryContent">
            <!-- –°—é–¥–∞ JS –≤—Å—Ç–∞–≤–∏—Ç —Å–ø–∏—Å–æ–∫ -->
        </div>
    </div>

    <!-- 3. VIEW: LOADING -->
    <div id="loadingView" class="view" style="text-align: center; padding-top: 50px;">
        <div class="loader"></div>
        <h3 id="loadTitle">–ó–∞–ø—É—Å–∫...</h3>
        <p id="loadDesc" style="color: var(--text-light);">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–µ–ª–µ–π</p>
    </div>

    <!-- 4. VIEW: TEST -->
    <div id="testView" class="view">
        <div class="progress"><div id="progressBar" class="bar"></div></div>
        <div class="card">
            <div style="display:flex; justify-content:space-between; margin-bottom: 15px; color: var(--text-light); font-size: 13px; font-weight: 600;">
                <span>–í–û–ü–†–û–° <span id="qNum">1</span></span>
            </div>
            <h3 id="qText" style="font-size: 22px; margin-bottom: 30px; line-height: 1.4;">...</h3>
            
            <div class="likert-grid">
                <div class="likert-opt" onclick="app.answer(1)">1</div>
                <div class="likert-opt" onclick="app.answer(2)">2</div>
                <div class="likert-opt" onclick="app.answer(3)">3</div>
                <div class="likert-opt" onclick="app.answer(4)">4</div>
                <div class="likert-opt" onclick="app.answer(5)">5</div>
            </div>
            <div style="display:flex; justify-content:space-between; font-size:13px; color:var(--text-light); padding:0 5px; font-weight:500;">
                <span>‚ùå –ù–µ—Ç / –ù–∏–∫–æ–≥–¥–∞</span>
                <span>‚úÖ –î–∞ / –í—Å–µ–≥–¥–∞</span>
            </div>
        </div>
    </div>

    <!-- 5. VIEW: RESULTS -->
    <div id="resultsView" class="view">
        <div class="card" id="resContent">
            <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <button class="btn" onclick="location.reload()">‚Ü∫ –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π</button>
            <button class="btn btn-secondary" id="saveTestBtn" onclick="app.saveCurrentTest()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫—É</button>
        </div>
    </div>
</div>

<!-- –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –°–ö–†–ò–ü–¢–û–í -->
<script src="app-settings.js"></script>
<script src="storage.js"></script> 

<script>
// --- API –ö–õ–ò–ï–ù–¢ (v3.0 Updated) ---
const api = {
    detectProvider(key) {
        return key.startsWith('AIza') ? 'gemini' : 'openrouter';
    },

    safeParseJSON(text) {
        try {
            return JSON.parse(text);
        } catch (e) {
            console.warn("Parsing failed, attempting regex extraction...");
            const match = text.match(/(\{[\s\S]*\}|\[[\s\S]*\])/);
            if (match) {
                try { return JSON.parse(match[0]); } catch (e2) {}
            }
            const mdMatch = text.match(/```(?:json)?\s*([\s\S]*?)\s*```/);
            if (mdMatch) {
                try { return JSON.parse(mdMatch[1]); } catch (e3) {}
            }
            throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞.");
        }
    },

    async call(taskName, userPrompt, schema, apiKey) {
        const provider = this.detectProvider(apiKey);
        
        // –í–ê–ñ–ù–û: –í—ã–±–æ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
        const systemPrompt = PROMPTS[provider][taskName];

        console.log(`üì° API Request: ${provider.toUpperCase()} (${taskName})`);

        if (provider === 'gemini') {
            return this.callGemini(systemPrompt, userPrompt, schema, taskName, apiKey);
        } else {
            return this.callOpenRouter(systemPrompt, userPrompt, schema, taskName, apiKey);
        }
    },

    async callOpenRouter(sys, user, schema, type, key) {
        const model = CONFIG.providers.openrouter.models[type];
        
        // –î–ª—è OpenRouter (Xiaomi) –º—ã –ø–æ–ª–∞–≥–∞–µ–º—Å—è –Ω–∞ –ø—Ä–∏–º–µ—Ä –≤ System Prompt
        const messages = [
            { role: 'system', content: sys },
            { role: 'user', content: user }
        ];

        try {
            const res = await fetch(CONFIG.providers.openrouter.endpoint, {
                method: 'POST',
                headers: CONFIG.providers.openrouter.headers(key),
                body: JSON.stringify({
                    model: model,
                    messages: messages,
                    // –í–∫–ª—é—á–∞–µ–º JSON mode
                    response_format: { type: "json_object" }, 
                    temperature: 0.6
                })
            });
            
            if (!res.ok) {
                const err = await res.json();
                throw new Error(err.error?.message || 'OpenRouter Error');
            }
            
            const data = await res.json();
            const content = data.choices[0].message.content;
            return this.safeParseJSON(content);

        } catch (e) {
            console.error("OpenRouter request failed:", e);
            throw e;
        }
    },

    async callGemini(sys, user, schema, type, key) {
        const model = CONFIG.providers.gemini.models[type];
        const url = `${CONFIG.providers.gemini.endpoint}${model}:generateContent?key=${key}`;

        // Gemini: –¥–æ–±–∞–≤–ª—è–µ–º —Å—Ö–µ–º—É –≤ –∫–æ–Ω–µ—Ü –ø—Ä–æ–º–ø—Ç–∞
        const prompt = `${sys}\n\n–û–¢–í–ï–¢–¨ –°–¢–†–û–ì–û –í FORMAT JSON:\n${JSON.stringify(schema)}\n\n–ó–ê–î–ê–ß–ê: ${user}`;

        const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    temperature: 0.7,
                    response_mime_type: "application/json"
                }
            })
        });

        if (!res.ok) {
            const err = await res.json();
            throw new Error(err.error?.message || 'Gemini Error');
        }

        const data = await res.json();
        return this.safeParseJSON(data.candidates[0].content.parts[0].text);
    }
};

    // --- UI LOGIC (THEMES) ---
    function toggleThemeMenu() {
        const menu = document.getElementById('themeMenu');
        menu.classList.toggle('active');
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –º–µ–Ω—é
        if (menu.classList.contains('active')) {
            document.addEventListener('click', closeMenuOutside);
        }
    }

    function closeMenuOutside(e) {
        if (!e.target.closest('.theme-menu') && !e.target.closest('.theme-toggle-btn')) {
            document.getElementById('themeMenu').classList.remove('active');
            document.removeEventListener('click', closeMenuOutside);
        }
    }

    function setTheme(themeName) {
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞—Ç—Ä–∏–±—É—Ç –Ω–∞ body
        if (themeName === 'light') {
            document.body.removeAttribute('data-theme');
        } else {
            document.body.setAttribute('data-theme', themeName);
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        localStorage.setItem('user_theme', themeName);
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é
        document.getElementById('themeMenu').classList.remove('active');
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–º—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    (function initTheme() {
        const saved = localStorage.getItem('user_theme');
        if (saved) setTheme(saved);
        
        // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—É—é —Ç–µ–º—É
        else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            setTheme('dark');
        }
    })();

// --- APP LOGIC (v3.0 Final) ---
const app = {
    state: { step: 0, answers: [], questions: [], blueprint: null, apiKey: '' },

    async start(e) {
        e.preventDefault();
        
        // 1. –û—á–∏—Å—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è (Critical fix)
        this.state.blueprint = null;
        this.state.questions = [];
        this.state.answers = [];
        this.state.step = 0;

        this.state.apiKey = document.getElementById('apiKeyInput').value.trim();
        const theme = document.getElementById('themeInput').value;
        const count = document.getElementById('qCountInput').value;
        const audience = document.getElementById('audienceInput').value;

        if(!this.state.apiKey) return alert("–í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á!");
        sessionStorage.setItem('temp_api_key', this.state.apiKey);

        this.setLoading(true, "üß† –ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä –ø—Ä–æ–µ–∫—Ç–∏—Ä—É–µ—Ç —Ç–µ—Å—Ç...");
        document.getElementById('errorBox').style.display = 'none';

        try {
            // –≠–¢–ê–ü 1: Blueprint (—Å –ø–æ–≤—Ç–æ—Ä–∞–º–∏ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏)
            let attempts = 0;
            let blueprint = null;
            
            while(attempts < 3 && !blueprint) {
                try {
                    attempts++;
                    const res = await api.call(
                        'architect',
                        `–¢–µ–º–∞: "${theme}". –ê—É–¥–∏—Ç–æ—Ä–∏—è: "${audience}". –°–æ–∑–¥–∞–π —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–µ—Å—Ç–∞.`,
                        SCHEMAS.blueprint,
                        this.state.apiKey
                    );
                    if (res && res.outcomes) blueprint = res;
                } catch (e) {
                    console.warn(`Blueprint attempt ${attempts} failed:`, e);
                    if (attempts === 3) throw e;
                }
            }
            this.state.blueprint = blueprint;

            // –≠–¢–ê–ü 2: –í–æ–ø—Ä–æ—Å—ã
            this.setLoading(true, "‚úçÔ∏è –ê–≤—Ç–æ—Ä –ø–∏—à–µ—Ç –≤–æ–ø—Ä–æ—Å—ã...");
            
            const genPrompt = `–¢–µ–º–∞: ${theme}. –¢–∏–ø: ${blueprint.testType}.
            –†–µ–∑—É–ª—å—Ç–∞—Ç—ã: ${JSON.stringify(blueprint.outcomes)}.
            –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–ø—Ä–æ—Å–æ–≤: ${count}.
            –†–∞—Å–ø—Ä–µ–¥–µ–ª–∏ –≤–µ—Å–∞ —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ (Soft Weights).`;

            const content = await api.call(
                'generator',
                genPrompt,
                SCHEMAS.questions,
                this.state.apiKey
            );
            
            this.state.questions = content.questions;
            
            // –°—Ç–∞—Ä—Ç
            this.renderQ();
            this.setView('test');

        } catch (err) {
            console.error(err);
            document.getElementById('errorBox').style.display = 'block';
            document.getElementById('errorBox').innerHTML = `<strong>–û—à–∏–±–∫–∞:</strong> ${err.message}`;
            this.setView('setup');
        }
    },

    renderQ() {
        const q = this.state.questions[this.state.step];
        document.getElementById('qNum').innerText = `${this.state.step + 1} / ${this.state.questions.length}`;
        document.getElementById('qText').innerText = q.text;
        
        const pct = (this.state.step / this.state.questions.length) * 100;
        document.getElementById('progressBar').style.width = pct + '%';
        
        document.querySelectorAll('.likert-opt').forEach(d => d.classList.remove('selected'));
    },

    answer(val) {
        this.state.answers[this.state.step] = val;
        document.querySelectorAll('.likert-opt')[val-1].classList.add('selected');
        
        setTimeout(() => {
            this.state.step++;
            if(this.state.step < this.state.questions.length) {
                this.renderQ();
            } else {
                this.finish();
            }
        }, 200);
    },

    finish() {
        this.setLoading(true, "üìä –î—É–Ω—è –ü–∞—Ö—É—á–∞—è —Å—á–∏—Ç–∞–µ—Ç...");
        this.setView('loading');
        
        setTimeout(() => {
            try {
                this.calc();
                this.setView('results');
            } catch (e) {
                alert("–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞: " + e.message);
                this.setView('setup');
            }
        }, 600);
    },

    calc() {
        if (!this.state.blueprint || !this.state.blueprint.outcomes) {
            throw new Error("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö —Ç–µ—Å—Ç–∞.");
        }
        
        const scores = {};
        this.state.blueprint.outcomes.forEach(o => scores[o.id] = 0);

        this.state.questions.forEach((q, idx) => {
            const ans = this.state.answers[idx];
            const userVal = (ans !== undefined ? ans : 3) - 3; // -2..+2
            
            if (q.mapping && Array.isArray(q.mapping)) {
                q.mapping.forEach(m => {
                    if(scores[m.outcomeId] !== undefined) {
                        scores[m.outcomeId] += (m.weight * userVal);
                    }
                });
            }
        });

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞
        const container = document.getElementById('resContent');
        let html = '';
        const isCategorical = (this.state.blueprint.testType !== 'dimensional');
        
        if(isCategorical) {
            const sorted = this.state.blueprint.outcomes.sort((a,b) => scores[b.id] - scores[a.id]);
            const win = sorted[0];
            let maxScore = Math.max(...Object.values(scores), 1); 

            html = `<div style="text-align:center; padding-bottom: 20px;">
                <div style="font-size:12px; text-transform:uppercase; letter-spacing:1px; color:#64748b; margin-bottom:10px;">–¢–≤–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</div>
                <h2 style="font-size:32px; margin:0 0 10px; color:var(--primary);">${win.name}</h2>
                <p style="font-size:18px; line-height:1.6;">${win.description}</p>
            </div>
            <div style="background:#f1f5f9; padding:20px; border-radius:12px;">
                <h4 style="margin:0 0 15px; color:#475569;">–î—Ä—É–≥–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã:</h4>`;
            
            sorted.slice(1).forEach(o => {
                let pct = 0;
                if (scores[o.id] > 0) pct = (scores[o.id] / maxScore) * 100;
                
                html += `<div class="res-item">
                    <div style="display:flex; justify-content:space-between; font-size:14px; margin-bottom:5px;">
                        <span>${o.name}</span>
                        <span style="color:#94a3b8; font-size:12px;">${Math.round(pct)}%</span>
                    </div>
                    <div class="res-bar-bg"><div class="res-bar-fill" style="width:${pct}%"></div></div>
                </div>`;
            });
            html += `</div>`;
        } else {
            html = `<h3 style="text-align:center; margin-bottom:25px;">–¢–≤–æ–π –ü—Ä–æ—Ñ–∏–ª—å</h3>`;
            this.state.blueprint.outcomes.forEach(o => {
                const s = scores[o.id];
                const pct = Math.min(100, Math.max(0, 50 + (s * 5)));
                let levelText = pct > 70 ? "–í—ã—Å–æ–∫–∏–π" : pct < 30 ? "–ù–∏–∑–∫–∏–π" : "–°—Ä–µ–¥–Ω–∏–π";

                html += `<div class="res-item">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <strong>${o.name}</strong>
                        <span class="badge">${levelText}</span>
                    </div>
                    <div class="res-bar-bg"><div class="res-bar-fill" style="width:${pct}%"></div></div>
                    <small style="color:#64748b; display:block; margin-top:5px;">${o.description}</small>
                </div>`;
            });
        }
        container.innerHTML = html;

        const saveBtn = document.getElementById('saveTestBtn');
        if (saveBtn) {
            saveBtn.innerText = "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫—É";
            saveBtn.disabled = false;
        }
    },

    setView(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(id+'View').classList.add('active');
    },
    
    setLoading(active, msg) {
        if(active) {
            this.setView('loading');
            document.getElementById('loadTitle').innerText = msg;
        }
    },

    openLibrary() {
        if (typeof Storage === 'undefined') return alert("–ú–æ–¥—É–ª—å —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω!");
        const html = Storage.renderLibraryHTML();
        document.getElementById('libraryContent').innerHTML = html;
        this.setView('library');
    },

    saveCurrentTest() {
        const themeInput = document.getElementById('themeInput');
        // –ï—Å–ª–∏ –ø–æ–ª–µ –æ—á–∏—â–µ–Ω–æ, –±–µ—Ä–µ–º –∏–∑ blueprint –∏–ª–∏ —Å—Ç–∞–≤–∏–º –¥–µ—Ñ–æ–ª—Ç
        let themeName = themeInput.value || "–ë–µ–∑ —Ç–µ–º—ã";
        
        // –ï—Å–ª–∏ –º—ã –∑–∞–≥—Ä—É–∑–∏–ª–∏ —Ç–µ—Å—Ç –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –∏ –ø—Ä–æ—Ö–æ–¥–∏–º –µ–≥–æ –∑–∞–Ω–æ–≤–æ, 
        // –ª—É—á—à–µ —Å—Ä–∞–∑—É –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ –∫–æ–ø–∏—é, –∏–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å (–º–µ—Ö–∞–Ω–∏–∑–º storage —Å–∞–º –¥–æ–±–∞–≤–∏—Ç —Ü–∏—Ñ—Ä—É)
        
        // –í—ã–∑—ã–≤–∞–µ–º save. –¢–µ–ø–µ—Ä—å –æ–Ω –≤–µ—Ä–Ω–µ—Ç —Å—Ç—Ä–æ–∫—É (–∏–º—è) –∏–ª–∏ false (–µ—Å–ª–∏ –≤–¥—Ä—É–≥ –æ—à–∏–±–∫–∞)
        const savedName = Storage.save(this.state.blueprint, this.state.questions, themeName);
        
        const btn = document.getElementById('saveTestBtn');
        if (savedName) {
            // –ï—Å–ª–∏ –∏–º—è –∏–∑–º–µ–Ω–∏–ª–æ—Å—å (–±—ã–ª–∞ –∫–æ–ø–∏—è), –ø–æ–∫–∞–∂–µ–º —ç—Ç–æ
            if (savedName !== themeName) {
                alert(`–¢–µ—Å—Ç —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º —É–∂–µ –±—ã–ª. –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –∫–∞–∫: "${savedName}"`);
            }
            
            btn.innerHTML = "‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!";
            btn.disabled = true;
            
            // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –≤ —Ñ–æ–Ω–µ, –µ—Å–ª–∏ –æ–Ω–∞ –æ—Ç–∫—Ä—ã—Ç–∞
            // this.openLibrary(); 
        } else {
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏.");
        }
    },

    loadSavedTest(id) {
        const test = Storage.getById(id);
        if (!test) return alert("–¢–µ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω!");
        this.state.blueprint = test.blueprint;
        this.state.questions = test.questions;
        this.state.step = 0;
        this.state.answers = [];
        this.renderQ();
        this.setView('test');
    },

    deleteTest(id) {
        if(confirm("–£–¥–∞–ª–∏—Ç—å?")) {
            Storage.delete(id);
            this.openLibrary();
        }
    }
};

document.getElementById('setupForm').addEventListener('submit', (e) => app.start(e));
</script>

</body>
</html>
